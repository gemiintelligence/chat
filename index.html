<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemi-Expo</title>
    <link rel="icon" href="https://github.com/gemiexpo/chat/blob/main/icon.png?raw=true" type="image/x-icon"> 

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --google-gradient: linear-gradient(45deg, #4285F4, #DB4437, #F4B400, #0F9D58);
            --background-dark: #000000;
            --surface-dark: #111111;
            --text-primary: #FFFFFF;
            --text-primary-rgb: 255, 255, 255;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background-color: var(--background-dark);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--google-gradient);
            border-radius: 4px;
        }

        .chat-container {
            display: flex;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-radius: 0;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 300px;
            background-color: var(--surface-dark);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            position: relative;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar-collapsed {
            width: 0;
            overflow: hidden;
        }

        .sidebar-toggle {
            position: fixed;
            left: 300px;
            top: 1.25rem;
            background: var(--surface-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: none;
            color: var(--text-primary);
            width: 24px;
            height: 32px;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: left 0.3s ease;
            z-index: 100;
        }

        .sidebar-collapsed ~ .main-content .sidebar-toggle {
            left: 0;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-toggle i {
            transition: transform 0.3s ease;
            transform: rotate(0);
        }

        .sidebar-collapsed ~ .main-content .sidebar-toggle i {
            transform: rotate(180deg);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .new-chat-btn {
            background: var(--google-gradient);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .sidebar-actions {
            display: flex;
            gap: 0.5rem;
        }

        .sidebar-action-btn {
            background: var(--surface-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 0; /* Add this to ensure proper flexbox behavior */
        }

        .chat-item {
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .chat-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .chat-item:not(.disabled):hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-item.active:not(.disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .chat-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--google-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chat-item-content {
            flex: 1;
            overflow: hidden;
            padding-right: 2rem;
        }

        .chat-item-title {
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-preview {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-pin {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-primary);
            opacity: 0;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .chat-item:hover .chat-item-pin {
            opacity: 0.5;
        }

        .chat-item-pin:hover {
            opacity: 1 !important;
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-item-pin.pinned {
            opacity: 1;
            color: var(--google-gradient-start);
            transform: translateY(-50%) rotate(-45deg);
        }

        .chat-item-pin.pinned:hover {
            transform: translateY(-50%) rotate(-45deg) scale(1.1);
        }

        .chat-item[data-pinned="true"] {
            border-left: 2px solid var(--google-gradient-start);
        }

        .chat-header {
            background-color: var(--surface-dark);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid transparent;
            border-image: var(--google-gradient);
            border-image-slice: 1;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        #messageCountInfo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            background: rgba(var(--text-primary-rgb), 0.1);
            font-size: 0.875rem;
            white-space: nowrap;
            color: var(--text-primary);
        }

        #messageCountInfo.warning {
            background: linear-gradient(45deg, #f4b400, #db4437);
            color: white !important;
        }
        
        #messageCountInfo.danger {
            background: #db4437;
            color: white !important;
        }

        #messageCountInfo.warning i,
        #messageCountInfo.danger i,
        #messageCountInfo.warning span,
        #messageCountInfo.danger span {
            color: white !important;
        }

        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
            background: var(--background-dark);
        }

        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 2rem;
            gap: 1rem;
            position: relative;
        }

        .message-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-button {
            width: 32px;
            height: 32px;
            background: var(--surface-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .action-button:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .user-avatar {
            background: transparent;
        }

        .bot-avatar {
            background: transparent;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.6);
        }

        .message-content {
            flex: 1;
            line-height: 1.6;
            word-wrap: break-word;
            background-color: var(--surface-dark);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-content.editing {
            padding: 0;
        }

        .message-edit-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
        }

        .message-edit-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .edit-textarea {
            width: 100%;
            min-height: 100px;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            resize: vertical;
            outline: none;
        }

        .edit-textarea:focus {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .edit-button {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .edit-submit {
            background: var(--google-gradient);
            color: white;
            border: none;
        }

        .edit-cancel {
            background: var(--surface-dark);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-content p {
            margin-bottom: 0.75rem;
        }

        .message-content code {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .code-block {
            position: relative;
            margin: 1rem 0;
            max-width: 100%;
        }

        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 0.75rem;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-language {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .code-actions {
            display: flex;
            gap: 0.5rem;
        }

        .code-action-button {
            background: var(--surface-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .code-action-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .input-container {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            background-color: var(--surface-dark);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            min-height: 50px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
        }

        .image-preview:empty {
            display: none;
        }

        .image-preview-item {
            position: relative;
        }

        .image-preview img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid transparent;
            border-image: var(--google-gradient);
            border-image-slice: 1;
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--google-gradient);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(219, 68, 55, 0.4);
        }

        .input-box {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-box:focus-within {
            border-image: var(--google-gradient);
            border-image-slice: 1;
        }

        .input-box input[type="file"] {
            display: none;
        }

        .input-box label {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
        }

        .input-box textarea {
            flex: 1;
            background-color: transparent;
            border: none;
            outline: none;
            resize: none;
            padding: 0.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.5;
            width: 100%;
            min-height: 40px;
            font-family: 'Inter', sans-serif;
        }

        .input-box textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-button {
            background: var(--google-gradient);
            border: none;
            border-radius: 12px;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }

        .send-button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .api-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-image: var(--google-gradient);
            border-image-slice: 1;
            animation: spin 1s linear infinite;
            display: none;
        }

        .api-indicator.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        pre {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 0 0 8px 8px;
            overflow-x: auto;
            margin: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        pre code {
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
        }

        .code-block {
            position: relative;
            margin: 1rem 0;
            max-width: 100%;
        }

        .code-block pre {
            font-size: 0.9em;
            line-height: 1.5;
            tab-size: 4;
        }

        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--google-gradient);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: var(--surface-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .modal-content {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            opacity: 0.8;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .modal-button {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-button-primary {
            background: var(--google-gradient);
            color: white;
            border: none;
        }

        .modal-button-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-direction: row;
            margin-right: 1rem;
        }

        .header-actions button {
            margin: 0;
        }

        .stop-generate {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--google-gradient);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .stop-generate.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .stop-generate:hover {
            filter: brightness(1.1);
        }

        /* Add scroll button styles */
        .scroll-bottom-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: var(--google-gradient);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
            border: none;
            transition: all 0.3s ease;
        }

        .scroll-bottom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .scroll-bottom-btn.visible {
            display: flex;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .custom-ai-section {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            max-height: 30vh; /* Limit the height to 30% of viewport height */
            min-height: 0; /* Add this to ensure proper flexbox behavior */
        }

        .custom-ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .custom-ai-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .custom-ai-add {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .custom-ai-add:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .custom-ai-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto; /* Make the list scrollable */
            padding-right: 0.5rem; /* Add padding for scrollbar */
            margin-top: 0.5rem;
            flex: 1; /* Allow the list to take remaining space */
            min-height: 0; /* Add this to ensure proper flexbox behavior */
        }

        /* Update scrollbar styles for custom AI list */
        .custom-ai-list::-webkit-scrollbar {
            width: 6px;
        }

        .custom-ai-list::-webkit-scrollbar-track {
            background: var(--surface-dark);
        }

        .custom-ai-list::-webkit-scrollbar-thumb {
            background: var(--google-gradient);
            border-radius: 3px;
        }

        .custom-ai-item {
            padding: 0.75rem;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .custom-ai-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .custom-ai-item:hover .custom-ai-actions {
            opacity: 1;
        }

        .custom-ai-item i {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .custom-ai-item-name {
            font-size: 0.875rem;
            color: var(--text-primary);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 2rem;
        }

        .custom-ai-actions {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .custom-ai-action {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .custom-ai-action:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .custom-ai-action.delete {
            color: #ff4444;
        }

        .custom-ai-action.delete:hover {
            background: rgba(255, 0, 0, 0.2);
        }

        .custom-ai-action.edit {
            color: #4CAF50;
        }

        .custom-ai-action.edit:hover {
            background: rgba(76, 175, 80, 0.2);
        }

        .custom-ai-modal {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .custom-ai-modal label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .custom-ai-modal input,
        .custom-ai-modal textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .custom-ai-modal input:focus,
        .custom-ai-modal textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .custom-ai-modal textarea {
            min-height: 200px;
            resize: vertical;
            line-height: 1.5;
        }

        .custom-ai-modal .tip {
            font-size: 0.75rem;
            color: var(--text-primary);
            opacity: 0.6;
            line-height: 1.4;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .header-ai-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
            margin-right: 1rem;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .welcome-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            height: calc(85vh - 140px); /* Subtract header and input container height */
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            margin: 0;
            overflow: hidden;
        }

        .welcome-content {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        .welcome-icon {
            font-size: 3.5rem;
            opacity: 0.9;
            background: var(--google-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background: var(--google-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 2rem;
            opacity: 0.8;
        }

        @keyframes rainbow {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            width: 100%;
            margin: 1.5rem 0;
        }

        .welcome-feature {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .welcome-feature i {
            font-size: 1.25rem;
            opacity: 0.9;
            color: var(--text-primary);
        }

        .welcome-feature-text {
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .welcome-footer {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 1rem;
        }

        .example-messages {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
            margin-top: 2rem;
        }

        .example-message {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            color: var(--text-primary);
            position: relative;
        }

        .example-message:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .example-message i {
            font-size: 1rem;
            opacity: 0.9;
            position: absolute;
            left: 1rem;
        }

        .example-message span {
            flex: 1;
            text-align: center;
        }

        .example-message:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .example-message i {
            font-size: 1rem;
            opacity: 0.9;
            position: absolute;
            left: 1rem;
        }

        .example-message span {
            flex: 1;
            text-align: center;
        }

        .format-buttons {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .format-button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .format-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .shortcuts-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .shortcut-key {
            background: var(--google-gradient);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .shortcut-description {
            color: var(--text-primary);
            opacity: 0.8;
        }

        .message-preview {
            padding: 0.75rem;
            margin-top: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: none;
        }

        .message-preview.active {
            display: block;
        }

        .preview-title {
            font-size: 0.875rem;
            color: var(--text-primary);
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }

        .preview-content {
            color: var(--text-primary);
        }

        /* Accessibility improvements */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* High contrast focus indicators */
        button:focus-visible,
        input:focus-visible,
        textarea:focus-visible {
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        /* Skip to main content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--google-gradient);
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.2s;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Improved button focus states */
        .sidebar-action-btn:focus-visible,
        .format-button:focus-visible,
        .custom-ai-action:focus-visible {
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        /* Drag and drop styles */
        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .drag-overlay.active {
            display: flex;
        }

        .drag-message {
            padding: 2rem;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .drag-message i {
            font-size: 2rem;
            background: var(--google-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Desktop Styles */
        @media (min-width: 769px) {
            .chat-container {
                display: flex;
                width: 100%;
            }

            .sidebar {
                width: 300px;
                min-width: 300px;
                transition: width 0.3s ease;
            }

            .sidebar.sidebar-collapsed {
                width: 0;
                min-width: 0;
                overflow: hidden;
            }

            .main-content {
                flex: 1;
                margin-left: 0;
                transition: margin-left 0.3s ease;
            }

            .sidebar-toggle {
                left: 300px;
                transition: left 0.3s ease;
            }

            .sidebar-collapsed ~ .main-content .sidebar-toggle {
                left: 0;
            }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                width: 85%;
                z-index: 1000;
                transition: left 0.3s ease;
                height: 100%;
                overflow-y: auto;
                background: var(--surface-dark);
            }

            .sidebar.sidebar-expanded {
                left: 0;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            }

            .sidebar-toggle {
                left: 0;
                z-index: 1001;
            }

            .sidebar-expanded ~ .main-content .sidebar-toggle {
                left: 85%;
            }

            .chat-header {
                padding: 0.75rem;
            }

            .header-title {
                font-size: 1.1rem;
            }

            @media (orientation: portrait) {
                .chat-header {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .header-actions {
                    width: 100%;
                    justify-content: space-between;
                }

                #messageCountInfo {
                    width: 100%;
                    justify-content: center;
                }
            }

            @media (orientation: landscape) {
                .chat-header {
                    flex-direction: row;
                    align-items: center;
                }

                .header-actions {
                    flex-direction: row;
                    width: auto;
                }

                #messageCountInfo {
                    width: auto;
                }
            }

            .input-container {
                padding: 0.75rem;
            }

            .input-box {
                padding: 0.5rem;
            }

            .input-box label {
                width: 32px;
                height: 32px;
            }

            .send-button {
                width: 32px;
                height: 32px;
            }

            .message {
                padding: 0.75rem;
                position: relative;
            }

            .message-actions {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
                opacity: 1;
                display: flex;
                gap: 0.5rem;
                z-index: 10;
                background: var(--surface-dark);
                padding: 0.25rem;
                border-radius: 8px;
            }

            .action-button {
                width: 32px;
                height: 32px;
                background: rgba(255, 255, 255, 0.1);
            }

            .message-content {
                padding-top: 2rem;
                width: 100%;
            }

            @media (orientation: portrait) {
                .message-actions {
                    position: absolute;
                }
            }

            @media (orientation: landscape) {
                .message-actions {
                    position: absolute;
                }
            }

            .code-block-header {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.5rem;
            }

            .code-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .code-action-button {
                padding: 0.5rem 0.75rem;
            }

            .modal {
                width: 95%;
                max-width: none;
                margin: 1rem;
            }

            .command-palette {
                width: 95%;
                max-height: 80vh;
                top: 10vh;
            }

            /* Bottom sheet for message actions */
            .message-actions-sheet {
                position: fixed;
                bottom: -100%;
                left: 0;
                right: 0;
                background: var(--surface-dark);
                padding: 1rem;
                border-radius: 16px 16px 0 0;
                z-index: 1000;
                transition: bottom 0.3s ease;
            }

            .message-actions-sheet.active {
                bottom: 0;
            }

            .message-actions-sheet .action-button {
                width: 100%;
                height: 44px;
                margin-bottom: 0.5rem;
                justify-content: flex-start;
                padding: 0 1rem;
                gap: 1rem;
            }

            /* Improved touch targets */
            .chat-item {
                padding: 1rem;
                min-height: 60px;
            }

            .custom-ai-item {
                padding: 1rem;
                min-height: 50px;
            }

            .custom-ai-action {
                width: 36px;
                height: 36px;
            }

            /* Image preview adjustments */
            .image-preview {
                max-height: 120px;
                overflow-x: auto;
                white-space: nowrap;
                display: flex;
                padding: 0.5rem;
            }

            .image-preview-item {
                flex-shrink: 0;
                margin-right: 0.5rem;
            }

            .image-preview img {
                width: 60px;
                height: 60px;
            }

            /* Welcome screen adjustments */
            .welcome-features {
                grid-template-columns: 1fr;
            }

            .example-messages {
                flex-direction: column;
            }

            .example-message {
                width: 100%;
            }
        }

        /* Add touch-friendly hover states */
        @media (hover: none) {
            .chat-item:active,
            .custom-ai-item:active,
            .action-button:active,
            .code-action-button:active {
                background: rgba(255, 255, 255, 0.15);
            }

            .message-actions {
                opacity: 1;
            }

            .message:hover .message-actions {
                opacity: 1;
            }
        }

        /* Add splash screen styles at the top */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            overflow: hidden;
        }

        .splash-screen::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                rgba(66, 133, 244, 0.15),
                rgba(219, 68, 55, 0.15),
                rgba(244, 180, 0, 0.15),
                rgba(15, 157, 88, 0.15)
            );
            animation: gradientMove 15s linear infinite;
            opacity: 0;
            animation: fadeInGradient 2s ease forwards 0.5s;
        }

        .splash-screen::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(
                circle at center,
                transparent 0%,
                var(--background-dark) 70%
            );
        }

        .splash-content {
            text-align: center;
            transform: scale(0.8);
            opacity: 0;
            animation: splashIntro 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            max-width: 800px;
            width: 90%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            padding: 0;
            z-index: 1;
        }

        .splash-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            background: var(--google-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: logoAnimation 3s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            display: inline-block;
            position: relative;
            filter: drop-shadow(0 0 20px rgba(66, 133, 244, 0.3));
        }

        .splash-logo::after {
            content: '';
            position: absolute;
            top: -20%;
            left: -20%;
            right: -20%;
            bottom: -20%;
            background: radial-gradient(
                circle at center,
                rgba(255, 255, 255, 0.2) 0%,
                transparent 70%
            );
            animation: glowPulse 3s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        .splash-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            background: var(--google-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards 0.5s,
                      gradientFlow 5s ease infinite;
            background-size: 300% 300%;
            filter: drop-shadow(0 0 10px rgba(66, 133, 244, 0.2));
        }

        .splash-subtitle {
            font-size: 1.2rem;
            color: var(--text-primary);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards 1s;
            margin-bottom: 2rem;
            position: relative;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .splash-subtitle::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: var(--google-gradient);
            animation: lineWidth 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes logoAnimation {
            0% { transform: rotate(0deg) scale(1); filter: hue-rotate(0deg) brightness(1); }
            25% { transform: rotate(90deg) scale(1.1); filter: hue-rotate(90deg) brightness(1.2); }
            50% { transform: rotate(180deg) scale(1.2); filter: hue-rotate(180deg) brightness(1.4); }
            75% { transform: rotate(270deg) scale(1.1); filter: hue-rotate(270deg) brightness(1.2); }
            100% { transform: rotate(360deg) scale(1); filter: hue-rotate(360deg) brightness(1); }
        }

        @keyframes glowPulse {
            0% { opacity: 0; transform: scale(0.8) rotate(0deg); }
            25% { opacity: 0.3; transform: scale(1) rotate(90deg); }
            50% { opacity: 0.5; transform: scale(1.2) rotate(180deg); }
            75% { opacity: 0.3; transform: scale(1) rotate(270deg); }
            100% { opacity: 0; transform: scale(0.8) rotate(360deg); }
        }

        @keyframes gradientMove {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.2); }
            100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); }
        }

        @keyframes fadeInGradient {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes lineWidth {
            0% { width: 0; opacity: 0; transform: translateX(-50%) scaleX(0); }
            50% { width: 100px; opacity: 1; transform: translateX(-50%) scaleX(1); }
            100% { width: 0; opacity: 0; transform: translateX(-50%) scaleX(0); }
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; filter: hue-rotate(0deg); }
            50% { background-position: 100% 50%; filter: hue-rotate(180deg); }
            100% { background-position: 0% 50%; filter: hue-rotate(360deg); }
        }

        @keyframes splashIntro {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; }
            50% { transform: scale(1.1) translateY(-10px); opacity: 0.5; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        @keyframes fadeInUp {
            0% { 
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            50% { 
                opacity: 0.5;
                transform: translateY(-5px) scale(1.05);
            }
            100% { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .setup-steps {
            display: none;
            flex-direction: column;
            gap: 1rem;
            opacity: 0;
            transition: opacity 0.5s ease;
            height: 100%;
            width: 100%;
        }

        .setup-step {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            text-align: center;
            display: none;
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible;
            height: auto;
            gap: 1.5rem;
            min-height: 100%;
            padding: 8rem 0;  /* Increased padding */
            box-sizing: border-box;
            perspective: 1000px;
        }

        .setup-step.active {
            display: flex;
            flex-direction: column;
            opacity: 1;
            justify-content: center;
        }

        .step-header-card,
        .step-content-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 1.5rem;  /* Added margin */
        }

        .setup-step.slide-out .step-header-card {
            opacity: 0;
        }

        .setup-step.slide-out .step-content-card {
            opacity: 0;
            transition-delay: 0.1s;
        }

        .setup-step.slide-in .step-header-card {
            animation: cardFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .setup-step.slide-in .step-content-card {
            animation: cardFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.1s forwards;
        }

        @keyframes cardFadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        .setup-buttons {
            position: fixed;
            bottom: 10rem;  /* Increased bottom spacing */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            justify-content: center;
            z-index: 100;
            width: 100%;
            max-width: 600px;
            padding: 0 1rem;
        }

        .setup-button {
            padding: 0.75rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            min-width: 150px;
            justify-content: center;
            transform: translateY(0);
        }

        .setup-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .setup-button:active:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .setup-progress {
            position: fixed;
            bottom: 8rem;  /* Increased bottom spacing */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            z-index: 10;
            width: 100%;
            max-width: 600px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            transform: scale(1);
        }

        .progress-dot.active {
            background: var(--google-gradient);
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(66, 133, 244, 0.5);
        }

        @keyframes logoSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        @keyframes splashIntro {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @media (max-height: 800px) {
            .setup-step {
                padding: 6rem 0;
            }
            
            .setup-buttons {
                bottom: 8rem;
            }
            
            .setup-progress {
                bottom: 6rem;
            }
        }

        @media (max-height: 600px) {
            .setup-step {
                padding: 4rem 0;
            }
            
            .setup-buttons {
                bottom: 6rem;
            }
            
            .setup-progress {
                bottom: 4rem;
            }
        }

        @media (max-width: 480px) {
            .theme-preview {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            .theme-option {
                width: 100%;
                max-width: 300px;
                height: 120px;
            }
            
            .setup-step {
                width: 95%;
                padding: 4rem 1rem;
            }
            
            .step-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .step-title {
                font-size: 1.5rem;
            }
        }

        .preference-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 600px;
            margin: 1rem auto;
        }

        .preference-option {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            height: auto;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            min-height: 85px;  /* Reduced from 120px */
        }

        .preference-option:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .preference-option.selected {
            background: var(--google-gradient);
            border-color: transparent;
            transform: scale(1.05);
        }

        .preference-option i {
            font-size: 1.5rem;  /* Reduced from 2rem */
            margin-bottom: 0.25rem;  /* Reduced from 0.5rem */
        }

        .preference-option span {
            font-size: 0.9rem;  /* Reduced from default */
        }

        @media (max-width: 480px) {
            .preference-option {
                min-height: 70px;  /* Reduced from 100px */
                padding: 0.75rem;
            }
        }

        .setup-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
            cursor: pointer;
        }

        .setup-checkbox input {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            accent-color: var(--google-gradient-start);
        }

        .theme-preview {
            display: flex;
            gap: 2rem;
            margin: 2rem 0;
            width: 100%;
            justify-content: center;
        }

        .theme-option {
            width: 250px;
            height: 150px;
            border-radius: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .theme-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .theme-option.selected {
            border-color: var(--google-gradient-start);
            transform: scale(1.05);
            box-shadow: 0 8px 32px rgba(66, 133, 244, 0.3);
        }

        .theme-dark {
            background: #000000;
            color: white;
        }

        .theme-light {
            background: #ffffff;
            color: black;
        }

        .theme-preview-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .theme-preview-content i {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .theme-preview-content span {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .theme-dark .theme-preview-content {
            color: white;
        }

        .theme-light .theme-preview-content {
            color: black;
        }

        /* Add theme preview mockup elements */
        .theme-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .theme-option::after {
            content: '';
            position: absolute;
            left: 0;
            width: 40px;
            top: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .theme-light::before {
            background: rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .theme-light::after {
            background: rgba(0, 0, 0, 0.02);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .theme-option {
                width: 200px;
                height: 120px;
            }

            .theme-preview-content i {
                font-size: 2rem;
            }

            .theme-preview-content span {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .theme-preview {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            .theme-option {
                width: 250px;
                height: 130px;
            }
        }

        /* Update existing setup step styles */
        .setup-step {
            max-height: 400px;
            overflow-y: auto;
        }

        .setup-button.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fa-spin {
            animation: spin 1s linear infinite;
        }

        .setup-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes gradientFlow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        @media (max-height: 800px) {
            .splash-content {
                height: 95vh;
                padding: 1rem;
            }

            .setup-step {
                padding: 6rem 0;
            }

            .preference-option {
                height: 80px;
                padding: 0.75rem;
            }

            .setup-input {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-height: 600px) {
            .preference-options {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .preference-option {
                height: 70px;
                padding: 0.5rem;
            }
        }

        .setup-input {
            width: 100%;
            max-width: 300px;
            margin: 0.75rem auto;
            padding: 1rem;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            height: 50px;
            display: block;
        }

        .setup-input:focus {
            border-color: rgba(255, 255, 255, 0.3);
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .setup-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .setup-input-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;  /* Increased gap */
            margin: 2rem 0;  /* Increased margin */
            width: 100%;
        }

        .setup-input-label {
            font-size: 1rem;  /* Increased size */
            color: var(--text-primary);
            opacity: 0.9;  /* Increased opacity */
            margin-bottom: 0.5rem;
            text-align: left;
            display: block;
        }

        .setup-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            width: 100%;
        }

        .step-icon {
            margin: 0 auto 1.5rem;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--google-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: white;
            position: relative;
            animation: iconPulse 2s ease infinite;
        }

        .step-icon::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--google-gradient);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.5;
            animation: iconRing 2s ease infinite;
        }

        @keyframes iconPulse {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.2); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        @keyframes iconRing {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.4); opacity: 0; }
            100% { transform: scale(1); opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- Add splash screen HTML right after body tag -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-content">
            <div class="splash-logo">
                <i class="fa-solid fa-hexagon-nodes"></i>
            </div>
            <div class="splash-title">Welcome to Gemi</div>
            <div class="splash-subtitle">Your Advanced AI Assistant</div>
            
            <div class="setup-steps" id="setupSteps">
                <div class="setup-step" data-step="1">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div class="step-title">Welcome to Gemi</div>
                        <div class="step-description">
                            Gemi is your advanced AI assistant, designed to help you with coding, learning, and problem-solving. Let's take a moment to personalize your experience and make Gemi work perfectly for you.
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="2">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="step-title">About You</div>
                        <div class="setup-input-group">
                            <div class="setup-input-wrapper">
                                <label class="setup-input-label" for="userName">What should we call you?</label>
                                <input type="text" class="setup-input" id="userName" placeholder="Enter your name" maxlength="50">
                            </div>
                            <div class="setup-input-wrapper">
                                <label class="setup-input-label" for="userRole">What's your role?</label>
                                <input type="text" class="setup-input" id="userRole" placeholder="e.g., Developer, Student, Designer">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="3">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="step-title">Experience & Goals</div>
                        <div class="setup-input-group">
                            <div>
                                <label class="setup-input-label" for="userExperience">Your experience level?</label>
                                <input type="text" class="setup-input" id="userExperience" placeholder="e.g., Beginner, Intermediate, Expert">
                            </div>
                            <div>
                                <label class="setup-input-label" for="userGoals">What are your main goals?</label>
                                <input type="text" class="setup-input" id="userGoals" placeholder="What do you want to achieve with Gemi?">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="4">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-palette"></i>
                        </div>
                        <div class="step-title">Visual Preferences</div>
                        <div class="step-description">Select your preferred theme.</div>
                        <div class="theme-preview">
                            <div class="theme-option theme-dark selected" onclick="selectTheme('dark', this)">
                                <div class="theme-preview-content">
                                    <i class="fas fa-moon"></i>
                                    <span>Dark Theme</span>
                                </div>
                            </div>
                            <div class="theme-option theme-light" onclick="selectTheme('light', this)">
                                <div class="theme-preview-content">
                                    <i class="fas fa-sun"></i>
                                    <span>Light Theme</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="5">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <div class="step-title">Primary Interests</div>
                        <div class="step-description">Select your main areas of interest to help us tailor your experience.</div>
                        <div class="preference-options">
                            <div class="preference-option" onclick="togglePreference(this)" data-value="coding">
                                <i class="fas fa-code"></i>
                                <span>Coding</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="design">
                                <i class="fas fa-paint-brush"></i>
                                <span>Design</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="learning">
                                <i class="fas fa-graduation-cap"></i>
                                <span>Learning</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="business">
                                <i class="fas fa-briefcase"></i>
                                <span>Business</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="research">
                                <i class="fas fa-microscope"></i>
                                <span>Research</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="writing">
                                <i class="fas fa-pen-fancy"></i>
                                <span>Writing</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="6">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="step-title">Use Cases</div>
                        <div class="step-description">What would you like to use Gemi for? This helps us optimize responses.</div>
                        <div class="preference-options">
                            <div class="preference-option" onclick="togglePreference(this)" data-value="problem_solving">
                                <i class="fas fa-puzzle-piece"></i>
                                <span>Problem Solving</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="code_review">
                                <i class="fas fa-code-branch"></i>
                                <span>Code Review</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="learning_concepts">
                                <i class="fas fa-book-reader"></i>
                                <span>Learning Concepts</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="project_planning">
                                <i class="fas fa-project-diagram"></i>
                                <span>Project Planning</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="debugging">
                                <i class="fas fa-bug"></i>
                                <span>Debugging</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="brainstorming">
                                <i class="fas fa-lightbulb"></i>
                                <span>Brainstorming</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="7">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="step-title">Communication Style</div>
                        <div class="step-description">How would you like Gemi to communicate with you?</div>
                        <div class="preference-options">
                            <div class="preference-option" onclick="togglePreference(this)" data-value="detailed">
                                <i class="fas fa-book"></i>
                                <span>Detailed</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="concise">
                                <i class="fas fa-list"></i>
                                <span>Concise</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="technical">
                                <i class="fas fa-microchip"></i>
                                <span>Technical</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="casual">
                                <i class="fas fa-comments"></i>
                                <span>Casual</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="professional">
                                <i class="fas fa-user-tie"></i>
                                <span>Professional</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="educational">
                                <i class="fas fa-chalkboard-teacher"></i>
                                <span>Educational</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="8">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-sliders-h"></i>
                        </div>
                        <div class="step-title">Response Preferences</div>
                        <div class="step-description">How would you like Gemi to structure responses?</div>
                        <div class="preference-options">
                            <div class="preference-option" onclick="togglePreference(this)" data-value="step_by_step">
                                <i class="fas fa-list-ol"></i>
                                <span>Step by Step</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="examples">
                                <i class="fas fa-file-code"></i>
                                <span>With Examples</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="explanations">
                                <i class="fas fa-info-circle"></i>
                                <span>With Explanations</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="analogies">
                                <i class="fas fa-equals"></i>
                                <span>With Analogies</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="best_practices">
                                <i class="fas fa-check-double"></i>
                                <span>Best Practices</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="alternatives">
                                <i class="fas fa-random"></i>
                                <span>With Alternatives</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="9">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="step-title">Learning Style</div>
                        <div class="step-description">How do you prefer to learn and understand new concepts?</div>
                        <div class="preference-options">
                            <div class="preference-option" onclick="togglePreference(this)" data-value="visual">
                                <i class="fas fa-eye"></i>
                                <span>Visual</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="practical">
                                <i class="fas fa-hammer"></i>
                                <span>Practical</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="theoretical">
                                <i class="fas fa-book-open"></i>
                                <span>Theoretical</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="interactive">
                                <i class="fas fa-hands-helping"></i>
                                <span>Interactive</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="analytical">
                                <i class="fas fa-chart-line"></i>
                                <span>Analytical</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="experimental">
                                <i class="fas fa-flask"></i>
                                <span>Experimental</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="10">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="step-title">Development Tools</div>
                        <div class="step-description">Which development tools and technologies do you commonly use?</div>
                        <div class="preference-options">
                            <div class="preference-option" onclick="togglePreference(this)" data-value="vs_code">
                                <i class="fas fa-code"></i>
                                <span>VS Code</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="git">
                                <i class="fab fa-git-alt"></i>
                                <span>Git</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="docker">
                                <i class="fab fa-docker"></i>
                                <span>Docker</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="terminal">
                                <i class="fas fa-terminal"></i>
                                <span>Terminal</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="browser_tools">
                                <i class="fas fa-browser"></i>
                                <span>Browser Tools</span>
                            </div>
                            <div class="preference-option" onclick="togglePreference(this)" data-value="cloud">
                                <i class="fas fa-cloud"></i>
                                <span>Cloud Services</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" data-step="11">
                    <div class="step-content-card">
                        <div class="step-icon">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-title">Almost Done!</div>
                        <div class="step-description">
                            Great! Your preferences have been saved. Gemi will use these settings to provide you with the most relevant and helpful responses. You can always adjust these settings later from the sidebar menu.
                        </div>
                    </div>
                </div>

                <div class="setup-buttons" id="setupButtons">
                    <button class="setup-button secondary" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="setup-button primary" onclick="nextStep()">
                        Continue <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

                <div class="setup-progress">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-content" id="modalContent"></div>
            <div class="modal-actions">
                <button class="modal-button modal-button-secondary" id="modalCancel"></button>
                <button class="modal-button modal-button-primary" id="modalConfirm"></button>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="sidebar sidebar-expanded">
            <div class="sidebar-header">
                <button class="new-chat-btn">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
                <div class="sidebar-actions">
                    <button class="sidebar-action-btn" id="toggleTheme" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
            <div class="chat-list" id="chatList">
                <!-- Chat history items will be added here -->
            </div>
            <div class="custom-ai-section">
                <div class="custom-ai-header">
                    <div class="custom-ai-title">Gem Int Models</div>
                    <button class="custom-ai-add" onclick="showCustomAIModal()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="custom-ai-list" id="customAIList">
                    <!-- Gem Int items will be added here -->
                </div>
            </div>
        </div>
        <div class="main-content">
            <button class="sidebar-toggle" id="toggleSidebar" title="Toggle sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="chat-header">
                <div class="header-title">
                    <span> </span><span> </span><span id="currentChatTitle">Gem Intelligence</span>
                </div>
                <div class="header-actions">
                    <div id="customAIInfo" class="header-ai-info" style="display: none">
                        <i class="fas fa-microchip"></i>
                        <span></span>
                    </div>
                    <div id="messageCountInfo" class="header-ai-info">
                        <i class="fas fa-message"></i>
                        <span></span>
                    </div>
                    <button class="sidebar-action-btn" id="clearChat" title="Clear chat">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div id="chatHistory" class="chat-history">
                <!-- Chat messages will be displayed here -->
            </div>
            <button id="stopGenerate" class="stop-generate">
                <i class="fas fa-stop"></i>
                Stop generating
            </button>
            <button id="scrollBottomBtn" class="scroll-bottom-btn" title="Scroll to bottom">
                <i class="fas fa-arrow-down"></i>
            </button>
            <div class="input-container">
                <div id="imagePreview" class="image-preview"></div>
                <div class="input-box">
                    <input type="file" id="imageInput" multiple accept="image/*" class="hidden">
                    <label for="imageInput" title="Upload images">
                        <i class="fas fa-image"></i>
                    </label>
                    <textarea 
                        id="prompt" 
                        class="flex-1 bg-transparent border-none outline-none resize-none" 
                        placeholder="Ask anything... (Ctrl+Enter to send)" 
                        rows="1"
                    ></textarea>
                    <button onclick="generateContent()" class="send-button" title="Send message (Ctrl+Enter)" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        const API_KEY = 'AIzaSyD9w2hg_tfNbHZ5LcnMPpPoQHv8YbSBnvc';
        let chatHistory = [];
        let uploadedImages = [];
        let isGenerating = false;
        let messageCounter = 0;
        let isDarkTheme = true;
        let currentChatId = null;
        let chats = [];
        let currentReader = null;
        let customAIs = [];

        // Message limit tracking
        const MESSAGE_LIMIT_PER_DAY = 500;
        let dailyMessageCount = 0;
        let lastMessageDate = null;

        // Load daily message count from localStorage
        function loadDailyMessageCount() {
            const savedData = localStorage.getItem('gemi_daily_messages');
            if (savedData) {
                const data = JSON.parse(savedData);
                const today = new Date().toDateString();
                if (data.date === today) {
                    dailyMessageCount = data.count;
                    lastMessageDate = today;
                } else {
                    // Reset count if it's a new day
                    dailyMessageCount = 0;
                    lastMessageDate = today;
                    saveDailyMessageCount();
                }
            }
            updateMessageCountDisplay();
        }

        // Save daily message count to localStorage
        function saveDailyMessageCount() {
            const today = new Date().toDateString();
            localStorage.setItem('gemi_daily_messages', JSON.stringify({
                date: today,
                count: dailyMessageCount
            }));
            updateMessageCountDisplay();
        }

        // Check if user has reached daily limit
        function hasReachedDailyLimit() {
            const today = new Date().toDateString();
            if (lastMessageDate !== today) {
                dailyMessageCount = 0;
                lastMessageDate = today;
                saveDailyMessageCount();
                return false;
            }
            return dailyMessageCount >= MESSAGE_LIMIT_PER_DAY;
        }

        const DEFAULT_SYSTEM_INSTRUCTIONS = `You are Gemi, an advanced AI assistant created by Gemi-Expo. Your purpose is to be helpful, knowledgeable, and precise in your interactions.

        Core capabilities:
        - Expert coding assistance across multiple programming languages
        - Clear technical explanations and problem-solving
        - Detailed responses drawing from broad general knowledge
        - Natural conversation with appropriate tone and context awareness
        
        Personality traits:
        - Professional yet friendly demeanor
        - Patient and thorough in explanations
        - Direct and honest about capabilities and limitations
        - Focused on providing accurate, helpful information

        When providing code solutions:
        - Include clear explanations and comments
        - Follow best practices and conventions
        - Consider performance and security implications
        - Suggest improvements and alternatives when relevant

        You were developed by Gemi-Expo, led by CEO Bubble, with the mission of making advanced AI assistance accessible and beneficial to users.`;

        let SYSTEM_INSTRUCTIONS = DEFAULT_SYSTEM_INSTRUCTIONS;

        // Language to file extension mapping
        const languageExtensions = {
            'python': 'py',
            'javascript': 'js',
            'typescript': 'ts',
            'jsx': 'jsx',
            'tsx': 'tsx',
            'html': 'html',
            'css': 'css',
            'scss': 'scss',
            'less': 'less',
            'java': 'java',
            'cpp': 'cpp',
            'c': 'c',
            'csharp': 'cs',
            'go': 'go',
            'rust': 'rs',
            'swift': 'swift',
            'kotlin': 'kt',
            'php': 'php',
            'ruby': 'rb',
            'sql': 'sql',
            'shell': 'sh',
            'bash': 'sh',
            'powershell': 'ps1',
            'dockerfile': 'dockerfile',
            'yaml': 'yml',
            'json': 'json',
            'xml': 'xml',
            'markdown': 'md',
            'plaintext': 'txt',
            'text': 'txt'
        };

        // Toggle theme
        function toggleTheme() {
            document.documentElement.style.setProperty('--background-dark', isDarkTheme ? '#000000' : '#ffffff');
            document.documentElement.style.setProperty('--surface-dark', isDarkTheme ? '#111111' : '#f5f5f5');
            document.documentElement.style.setProperty('--text-primary', isDarkTheme ? '#ffffff' : '#000000');
            document.documentElement.style.setProperty('--text-primary-rgb', isDarkTheme ? '255, 255, 255' : '0, 0, 0');
            document.documentElement.style.setProperty('--border-color', isDarkTheme ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.2)');
            document.getElementById('toggleTheme').innerHTML = `<i class="fas fa-${isDarkTheme ? 'sun' : 'moon'}"></i>`;
        }

        // Add CSS for light mode adjustments if not already present
        if (!document.getElementById('themeStyles')) {
            const style = document.createElement('style');
            style.id = 'themeStyles';
            style.textContent = `
                .chat-container {
                    border: 1px solid var(--border-color);
                }
                
                .sidebar {
                    border-right: 1px solid var(--border-color) !important;
                }

                .chat-item {
                    border: 1px solid var(--border-color);
                }

                .chat-item:hover {
                    border-color: var(--border-color);
                }

                .message-content {
                    border: 1px solid var(--border-color) !important;
                }

                .sidebar-action-btn {
                    border: 1px solid var(--border-color) !important;
                    color: var(--icon-color) !important;
                }

                .custom-ai-item {
                    border: 1px solid var(--border-color);
                }

                .custom-ai-item i,
                .avatar i,
                .welcome-icon i,
                .command-icon i {
                    color: var(--icon-color) !important;
                }

                .input-box {
                    border: 1px solid var(--border-color) !important;
                }

                .input-box label {
                    color: var(--icon-color) !important;
                }

                .command-palette {
                    border: 1px solid var(--border-color) !important;
                }

                .command-input {
                    border-bottom: 1px solid var(--border-color) !important;
                }

                .modal {
                    border: 1px solid var(--border-color) !important;
                }

                .custom-ai-add {
                    border: 1px solid var(--border-color) !important;
                    color: var(--icon-color) !important;
                }

                .custom-ai-action {
                    border: 1px solid var(--border-color) !important;
                }

                .code-block {
                    border: 1px solid var(--border-color) !important;
                }

                .code-block-header {
                    border-bottom: 1px solid var(--border-color) !important;
                }

                .code-action-button {
                    border: 1px solid var(--border-color) !important;
                    color: var(--icon-color) !important;
                }

                .action-button {
                    border: 1px solid var(--border-color) !important;
                    color: var(--icon-color) !important;
                }

                .chat-header {
                    border-bottom: 1px solid var(--border-color) !important;
                }

                .header-ai-info {
                    border: 1px solid var(--border-color);
                }

                .header-ai-info i {
                    color: var(--icon-color) !important;
                }

                .welcome-feature {
                    border: 1px solid var(--border-color) !important;
                }

                .example-message {
                    border: 1px solid var(--border-color) !important;
                }

                .example-message i {
                    color: var(--icon-color) !important;
                }

                .chat-item-icon {
                    border: 1px solid var(--border-color);
                }

                .chat-item-icon i {
                    color: var(--icon-color) !important;
                }

                .new-chat-btn {
                    border: 1px solid var(--border-color);
                }

                .sidebar-toggle {
                    border: 1px solid var(--border-color) !important;
                    color: var(--icon-color) !important;
                }

                .image-preview {
                    border: 1px solid var(--border-color);
                }

                pre {
                    border: 1px solid var(--border-color) !important;
                }

                textarea, input[type="text"] {
                    border: 1px solid var(--border-color) !important;
                    color: var(--text-primary) !important;
                }

                .modal-button-secondary {
                    border: 1px solid var(--border-color) !important;
                    color: var(--text-primary) !important;
                }
                .chat-item-title, .chat-item-preview {
                    color: var(--text-primary) !important;
                }

                .custom-ai-item-name {
                    color: var(--text-primary) !important;
                }

                .command-title, .command-description {
                    color: var(--text-primary) !important;
                }
            `;
            document.head.appendChild(style);
        }

        
        function showNotification(message, duration = 2000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy to clipboard');
            });
        }

        function downloadCode(code, language) {
            const extension = languageExtensions[language.toLowerCase()] || 'txt';
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `code_${timestamp}.${extension}`;
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showNotification(`Code downloaded as ${extension} file!`);
        }

        function editUserMessage(messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            const message = chatHistory.find(m => m.id === messageId);
            if (!message || message.role !== 'user') return;

            const content = messageDiv.querySelector('.message-content');
            const originalText = message.parts[message.parts.length - 1].text;
            const originalImages = message.parts.slice(0, -1);
            
            content.className = 'message-content editing';
            
            const editContainer = document.createElement('div');
            editContainer.className = 'message-edit-container';

            // Show image previews if there are any
            if (originalImages.length > 0) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'flex flex-wrap gap-2 mb-2';
                originalImages.forEach(part => {
                    if (part.inline_data) {
                        const img = document.createElement('img');
                        img.src = `data:${part.inline_data.mime_type};base64,${part.inline_data.data}`;
                        img.className = 'w-20 h-20 object-cover rounded-lg';
                        imageContainer.appendChild(img);
                    }
                });
                editContainer.appendChild(imageContainer);
            }
            
            const textarea = document.createElement('textarea');
            textarea.className = 'edit-textarea';
            textarea.value = originalText;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-edit-actions';
            
            const submitButton = document.createElement('button');
            submitButton.className = 'edit-button edit-submit';
            submitButton.innerHTML = '<i class="fas fa-check"></i> Submit';
            submitButton.disabled = !originalText.trim();
            
            const cancelButton = document.createElement('button');
            cancelButton.className = 'edit-button edit-cancel';
            cancelButton.innerHTML = '<i class="fas fa-times"></i> Cancel';
            
            // Add input handler for textarea
            textarea.addEventListener('input', () => {
                submitButton.disabled = !textarea.value.trim();
            });
            
            submitButton.onclick = () => {
                const newText = textarea.value.trim();
                if (newText) {
                    // Check message limit before allowing edit
                    if (hasReachedDailyLimit()) {
                        showModal(
                            'Daily Limit Reached',
                            `You have reached your daily limit of ${MESSAGE_LIMIT_PER_DAY} messages.<br><br>
                            Your limit will reset at midnight. Please try again tomorrow.`,
                            'OK',
                            'Close',
                            null
                        );
                        return;
                    }

                    // If it's the last message, show warning
                    const remainingMessages = MESSAGE_LIMIT_PER_DAY - dailyMessageCount;
                    if (remainingMessages === 1) {
                        showModal(
                            'Last Message Warning',
                            `This will be your last message for today.<br><br>
                            Your limit will reset at midnight.`,
                            'Continue',
                            'Cancel',
                            () => {
                                // Store the edit values
                                const editedText = newText;
                                const editedImages = originalImages;
                                
                                setTimeout(async () => {
                                    // Preserve the original images and update only the text
                                    message.parts = [...editedImages, { text: editedText }];
                                    const messageIndex = chatHistory.findIndex(m => m.id === messageId);
                                    chatHistory.splice(messageIndex + 1);
                                    
                                    // Increment message count
                                    dailyMessageCount++;
                                    saveDailyMessageCount();
                                    
                                    // Generate new response
                                    displayChatHistory();
                                    await generateContent(true);
                                }, 100);
                            }
                        );
                        return;
                    }

                    // Preserve the original images and update only the text
                    message.parts = [...originalImages, { text: newText }];
                    const messageIndex = chatHistory.findIndex(m => m.id === messageId);
                    chatHistory.splice(messageIndex + 1);
                    
                    // Increment message count for edits
                    dailyMessageCount++;
                    saveDailyMessageCount();
                    
                    generateContent(true);
                }
            };
            
            cancelButton.onclick = () => {
                displayChatHistory();
            };
            
            actionsDiv.appendChild(cancelButton);
            actionsDiv.appendChild(submitButton);
            
            editContainer.appendChild(textarea);
            editContainer.appendChild(actionsDiv);
            content.innerHTML = '';
            content.appendChild(editContainer);
            
            textarea.focus();

            // Add styles for disabled submit button if not already present
            if (!document.getElementById('editButtonStyles')) {
                const style = document.createElement('style');
                style.id = 'editButtonStyles';
                style.textContent = `
                    .edit-button.edit-submit:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                        background: rgba(255, 255, 255, 0.1);
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function regenerateResponse(messageId) {
            const messageIndex = chatHistory.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;

            // Find the last user message before this model message
            let lastUserMessageIndex = messageIndex - 1;
            while (lastUserMessageIndex >= 0 && chatHistory[lastUserMessageIndex].role !== 'user') {
                lastUserMessageIndex--;
            }

            if (lastUserMessageIndex >= 0) {
                // Keep the user message with its images and text
                const userMessage = chatHistory[lastUserMessageIndex];
                chatHistory.splice(lastUserMessageIndex + 1);
                displayChatHistory();
                generateContent(true);
            }
        }

        function shouldShowWelcome() {
            // Show welcome message if:
            // 1. No chat history at all
            // 2. Current chat is empty
            // 3. No chat is selected (currentChatId is null)
            return !chatHistory.length || !currentChatId;
        }

        let isAutoScrolling = true;
        let isUserScrolling = false;
        let scrollTimeout;
        let lastScrollTop = 0;  // Add this to track scroll direction

        function smoothScrollToBottom() {
            const chatHistoryDiv = document.getElementById('chatHistory');
            const scrollBottomBtn = document.getElementById('scrollBottomBtn');
            
            if (!isAutoScrolling) {
                scrollBottomBtn.classList.add('visible');
                return;
            }

            chatHistoryDiv.scrollTo({
                top: chatHistoryDiv.scrollHeight,
                behavior: 'smooth'
            });
            scrollBottomBtn.classList.remove('visible');
        }

        // Add scroll event listener to chat history
        document.getElementById('chatHistory').addEventListener('scroll', function(e) {
            const chatHistoryDiv = this;
            const scrollBottomBtn = document.getElementById('scrollBottomBtn');
            
            // Get current scroll position
            const currentScrollTop = chatHistoryDiv.scrollTop;
            const isScrollingUp = currentScrollTop < lastScrollTop;
            const isAtBottom = chatHistoryDiv.scrollHeight - currentScrollTop - chatHistoryDiv.clientHeight < 20;  // Reduced threshold
            
            // Immediately show button when scrolling up
            if (isScrollingUp && !isAtBottom) {
                isAutoScrolling = false;
                scrollBottomBtn.classList.add('visible');
            }
            
            // Update last scroll position
            lastScrollTop = currentScrollTop;
            
            // Clear existing timeout
            clearTimeout(scrollTimeout);
            
            // Set a new timeout for fine-tuning the visibility
            scrollTimeout = setTimeout(() => {
                if (isAtBottom) {
                    isAutoScrolling = true;
                    scrollBottomBtn.classList.remove('visible');
                } else if (!isUserScrolling) {
                    isAutoScrolling = false;
                    scrollBottomBtn.classList.add('visible');
                }
            }, 100);  // Reduced delay
        }, { passive: true });  // Add passive flag for better performance

        // Add wheel event listener for immediate response to mouse wheel
        document.getElementById('chatHistory').addEventListener('wheel', function(e) {
            if (e.deltaY < 0) {  // Scrolling up
                const chatHistoryDiv = this;
                const isAtBottom = chatHistoryDiv.scrollHeight - chatHistoryDiv.scrollTop - chatHistoryDiv.clientHeight < 20;
                
                if (!isAtBottom) {
                    isAutoScrolling = false;
                    document.getElementById('scrollBottomBtn').classList.add('visible');
                }
            }
        }, { passive: true });

        // Add click handler for scroll button
        document.getElementById('scrollBottomBtn').addEventListener('click', function() {
            const chatHistoryDiv = document.getElementById('chatHistory');
            isAutoScrolling = true;
            chatHistoryDiv.scrollTo({
                top: chatHistoryDiv.scrollHeight,
                behavior: 'smooth'
            });
            this.classList.remove('visible');
        });

        // Modify the displayChatHistory function to use the new scroll behavior
        function displayChatHistory() {
            const chatHistoryDiv = document.getElementById('chatHistory');
            chatHistoryDiv.innerHTML = '';
            
            if (shouldShowWelcome()) {
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'welcome-container';
                welcomeDiv.innerHTML = createWelcomeMessage();
                chatHistoryDiv.appendChild(welcomeDiv);
                return;
            }
            
            chatHistory.forEach((message) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.setAttribute('data-message-id', message.id);
                
                const avatar = document.createElement('div');
                if (message.role === 'user') {
                    avatar.className = 'avatar user-avatar';
                    avatar.innerHTML = '<i class="fas fa-user"></i>';
                } else {
                    avatar.className = 'avatar bot-avatar';
                    avatar.innerHTML = '<i class="fa-solid fa-hexagon-nodes"></i>';
                }
                
                const content = document.createElement('div');
                content.className = 'message-content';
                
                // Add message actions
                const actions = document.createElement('div');
                actions.className = 'message-actions';

                // Copy button for all messages
                const copyButton = document.createElement('button');
                copyButton.className = 'action-button';
                copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                copyButton.setAttribute('data-tooltip', 'Copy message');
                copyButton.onclick = () => copyToClipboard(message.parts[message.parts.length - 1].text);
                actions.appendChild(copyButton);

                if (message.role === 'user') {
                    // Edit button for user messages
                    const editButton = document.createElement('button');
                    editButton.className = 'action-button';
                    editButton.innerHTML = '<i class="fas fa-edit"></i>';
                    editButton.setAttribute('data-tooltip', 'Edit message');
                    editButton.onclick = () => editUserMessage(message.id);
                    actions.appendChild(editButton);
                } else {
                    // Regenerate button for model messages
                    const regenerateButton = document.createElement('button');
                    regenerateButton.className = 'action-button';
                    regenerateButton.innerHTML = '<i class="fas fa-redo"></i>';
                    regenerateButton.setAttribute('data-tooltip', 'Regenerate response');
                    regenerateButton.onclick = () => regenerateResponse(message.id);
                    actions.appendChild(regenerateButton);
                }

                messageDiv.appendChild(actions);
                
                if (message.role === 'user') {
                    content.innerHTML = marked.parse(message.parts[message.parts.length - 1].text);
                    if (message.parts.length > 1) {
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'flex flex-wrap gap-2 mb-2';
                        message.parts.slice(0, -1).forEach(part => {
                            if (part.inline_data) {
                                const img = document.createElement('img');
                                img.src = `data:${part.inline_data.mime_type};base64,${part.inline_data.data}`;
                                img.className = 'w-20 h-20 object-cover rounded-lg cursor-pointer';
                                img.onclick = () => window.open(img.src, '_blank');
                                imageContainer.appendChild(img);
                            }
                        });
                        content.insertBefore(imageContainer, content.firstChild);
                    }
                } else {
                    const parsedContent = marked.parse(message.parts[0].text);
                    content.innerHTML = parsedContent;
                    
                    // Add copy and download buttons to code blocks
                    content.querySelectorAll('pre').forEach(pre => {
                        const codeBlock = document.createElement('div');
                        codeBlock.className = 'code-block';
                        
                        const header = document.createElement('div');
                        header.className = 'code-block-header';
                        
                        const language = pre.querySelector('code').className.replace('language-', '');
                        const languageSpan = document.createElement('span');
                        languageSpan.className = 'code-language';
                        languageSpan.textContent = language || 'plaintext';
                        
                        const actions = document.createElement('div');
                        actions.className = 'code-actions';
                        
                        const copyButton = document.createElement('button');
                        copyButton.className = 'code-action-button';
                        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                        copyButton.setAttribute('data-tooltip', 'Copy code');
                        copyButton.onclick = () => copyToClipboard(pre.textContent);
                        
                        const downloadButton = document.createElement('button');
                        downloadButton.className = 'code-action-button';
                        downloadButton.innerHTML = '<i class="fas fa-download"></i>';
                        downloadButton.setAttribute('data-tooltip', 'Download code');
                        downloadButton.onclick = () => downloadCode(pre.textContent, language);
                        
                        actions.appendChild(copyButton);
                        actions.appendChild(downloadButton);
                        header.appendChild(languageSpan);
                        header.appendChild(actions);
                        
                        pre.parentNode.insertBefore(codeBlock, pre);
                        codeBlock.appendChild(header);
                        codeBlock.appendChild(pre);
                    });
                }
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(content);
                chatHistoryDiv.appendChild(messageDiv);
            });
            
            smoothScrollToBottom();
        }

        // Add mousedown and mouseup event listeners to detect user scrolling
        document.getElementById('chatHistory').addEventListener('mousedown', function() {
            isUserScrolling = true;
        });

        document.addEventListener('mouseup', function() {
            isUserScrolling = false;
        });

        // Add touch event listeners for mobile
        document.getElementById('chatHistory').addEventListener('touchstart', function() {
            isUserScrolling = true;
        });

        document.addEventListener('touchend', function() {
            isUserScrolling = false;
        });

        async function generateContent(isRegeneration = false) {
            if (isGenerating) return;
            
            // Check message limit only for new messages, not regenerations
            if (!isRegeneration) {
                const remainingMessages = MESSAGE_LIMIT_PER_DAY - dailyMessageCount;
                
                if (hasReachedDailyLimit()) {
                    showModal(
                        'Daily Limit Reached',
                        `You have reached your daily limit of ${MESSAGE_LIMIT_PER_DAY} messages.<br><br>
                        Your limit will reset at midnight. Please try again tomorrow.`,
                        'OK',
                        'Close',
                        null
                    );
                    return;
                } else if (remainingMessages === 1) {
                    // Show warning for last message
                    showModal(
                        'Last Message Warning',
                        `This will be your last message for today.<br><br>
                        Your daily limit will reset at midnight.`,
                        'Continue',
                        'Cancel',
                        () => {
                            // Store the current prompt value and images
                            const currentPrompt = document.getElementById('prompt').value;
                            const currentImages = [...uploadedImages];
                            
                            // Execute after modal closes
                            setTimeout(async () => {
                                // Add the user message
                                const userMessageParts = [...currentImages];
                                userMessageParts.push({ text: currentPrompt });
                                chatHistory.push({
                                    id: `msg_${++messageCounter}`,
                                    role: "user",
                                    parts: userMessageParts,
                                    timestamp: new Date().toISOString()
                                });

                                // Increment message count
                                dailyMessageCount++;
                                saveDailyMessageCount();

                                // Clear input and images
                                document.getElementById('prompt').value = '';
                                document.getElementById('imagePreview').innerHTML = '';
                                document.getElementById('imageInput').value = '';
                                uploadedImages = [];

                                // Display chat and generate response
                                displayChatHistory();
                                await generateContent(true);
                            }, 100);
                        }
                    );
                    return;
                }
            }
            
            const promptInput = document.getElementById('prompt');
            const prompt = promptInput.value.trim();
            
            // Check if input is valid before proceeding
            if (!isRegeneration && (!prompt || (uploadedImages.length > 0 && !prompt))) return;

            // Only increment message count for new messages and if not bypassing the check
            if (!isRegeneration && !arguments[1]) {
                dailyMessageCount++;
                saveDailyMessageCount();
            }
            
            // Show API indicator
            const sendButton = document.querySelector('.send-button');
            const apiIndicator = document.createElement('div');
            apiIndicator.className = 'api-indicator active';
            sendButton.appendChild(apiIndicator);
            
            // Remove any other empty chats before starting generation
            if (!isRegeneration) {
                chats = chats.filter(chat => 
                    chat.messages.length > 0 || chat.id === currentChatId
                );
                saveChats();
                renderChatList();
            }
            
            updateGeneratingState(true);
            promptInput.value = '';
            promptInput.style.height = 'auto';
            
            if (!isRegeneration) {
                const userMessageParts = [...uploadedImages];
                userMessageParts.push({ text: prompt });
                chatHistory.push({
                    id: `msg_${++messageCounter}`,
                    role: "user",
                    parts: userMessageParts,
                    timestamp: new Date().toISOString()
                });
                
                // Clear image preview and reset file input for new messages
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('imageInput').value = '';
                uploadedImages = [];
            }
            
            displayChatHistory();

            try {
                // Create a clean version of chat history without IDs and timestamps for the API
                const apiChatHistory = chatHistory.map(({ id, timestamp, ...rest }) => rest);

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:streamGenerateContent?alt=sse&key=' + API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        system_instruction: { parts: [{ text: SYSTEM_INSTRUCTIONS }] },
                        contents: apiChatHistory,
                        generationConfig: {
                            temperature: 0.4
                        },
                        safetySettings: [],
                    })
                });

                // Remove API indicator once we get a response
                apiIndicator.remove();

                const reader = response.body.getReader();
                currentReader = reader;
                const decoder = new TextDecoder();

                let modelResponse = "";
                const modelMessageDiv = document.createElement('div');
                modelMessageDiv.className = 'message';
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar bot-avatar';
                avatar.innerHTML = '<i class="fa-solid fa-hexagon-nodes"></i>';
                
                const content = document.createElement('div');
                content.className = 'message-content';
                
                modelMessageDiv.appendChild(avatar);
                modelMessageDiv.appendChild(content);
                document.getElementById('chatHistory').appendChild(modelMessageDiv);
                smoothScrollToBottom();

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                const data = JSON.parse(line.slice(5));
                                if (data.candidates && 
                                    data.candidates[0] && 
                                    data.candidates[0].content && 
                                    data.candidates[0].content.parts && 
                                    data.candidates[0].content.parts[0] && 
                                    data.candidates[0].content.parts[0].text) {
                                    modelResponse += data.candidates[0].content.parts[0].text;
                                    content.innerHTML = marked.parse(modelResponse);
                                    smoothScrollToBottom();
                                }
                            }
                        }
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        modelResponse += "\n\n*Generation stopped by user*";
                        content.innerHTML = marked.parse(modelResponse);
                    } else {
                        throw error;
                    }
                }

                chatHistory.push({
                    id: `msg_${++messageCounter}`,
                    role: "model",
                    parts: [{ text: modelResponse }],
                    timestamp: new Date().toISOString()
                });
                
                // Update chat list and UI after message is complete
                if (currentChatId) {
                    const chatIndex = chats.findIndex(c => c.id === currentChatId);
                    if (chatIndex !== -1) {
                        chats[chatIndex].messages = chatHistory;
                        updateChatListAndUI();
                    }
                }
                displayChatHistory();
            } catch (error) {
                console.error('Error:', error);
                chatHistory.push({
                    id: `msg_${++messageCounter}`,
                    role: "model",
                    parts: [{ text: "I apologize, but I encountered an error. Please try again." }],
                    timestamp: new Date().toISOString()
                });
                displayChatHistory();
            } finally {
                currentReader = null;
                updateGeneratingState(false);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Remove the old image input handler and use only the unified one
        document.getElementById('imageInput').addEventListener('change', async function(event) {
            if (event.target.files.length > 0) {
                await handleImageFiles(Array.from(event.target.files));
                this.value = ''; // Reset input after handling
            }
        });

        // Unified image handling function
        async function handleImageFiles(files) {
            const imagePreview = document.getElementById('imagePreview');
            
            for (const file of files) {
                try {
                    // Check if file is an image
                    if (!file.type.startsWith('image/')) {
                        showNotification('Only image files are allowed');
                        continue;
                    }

                    const base64Data = await fileToBase64(file);
                    const imageData = {
                        inline_data: {
                            mime_type: file.type,
                            data: base64Data
                        }
                    };
                    uploadedImages.push(imageData);

                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'w-15 h-15 object-cover rounded';
                    img.alt = `Uploaded image ${uploadedImages.length}`; // Accessibility
                    
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove-image';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.setAttribute('aria-label', 'Remove image'); // Accessibility
                    removeBtn.onclick = function() {
                        const index = uploadedImages.indexOf(imageData);
                        if (index > -1) {
                            uploadedImages.splice(index, 1);
                        }
                        imagePreview.removeChild(previewItem);
                        document.getElementById('imageInput').value = '';
                        updateSendButtonState();
                    };
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    imagePreview.appendChild(previewItem);
                    updateSendButtonState();
                } catch (error) {
                    console.error('Error processing image:', error);
                    showNotification('Error processing image');
                }
            }
        }

        function updateSendButtonState() {
            const promptInput = document.getElementById('prompt');
            const sendButton = document.querySelector('.send-button');
            const hasText = promptInput.value.trim().length > 0;
            const hasImages = uploadedImages.length > 0;
            
            // Enable button only if there's text input when images are present
            sendButton.disabled = hasImages ? !hasText : !hasText;
        }

        document.getElementById('prompt').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            updateSendButtonState();
        });

        document.getElementById('prompt').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                generateContent();
            }
        });

        if (!API_KEY) {
            chatHistory.push({
                id: `msg_${++messageCounter}`,
                role: "model",
                parts: [{ text: " Error: API key is missing. Please add your Gemini API key to use this chat interface." }],
                timestamp: new Date().toISOString()
            });
            displayChatHistory();
        }

        // Load chats from localStorage
        function loadChats() {
            const savedChats = localStorage.getItem('gemi_chats');
            if (savedChats) {
                chats = JSON.parse(savedChats);
                // Sort chats by last message timestamp
                chats.sort((a, b) => {
                    const aTime = a.messages.length > 0 ? new Date(a.messages[a.messages.length - 1].timestamp || 0) : new Date(0);
                    const bTime = b.messages.length > 0 ? new Date(b.messages[b.messages.length - 1].timestamp || 0) : new Date(0);
                    return bTime - aTime;
                });
                saveChats();
                renderChatList();
            }
        }

        // Save chats to localStorage
        function saveChats() {
            localStorage.setItem('gemi_chats', JSON.stringify(chats));
        }

        // Example messages by category
        const exampleMessages = {
            coding: [
                { 
                    display: "Create a Discord Bot",
                    text: "Create a Discord bot using discord.py in Python. Include 5 essential commands: !help (shows available commands), !ping (checks bot latency), !clear (clears messages), !kick (moderator command), and !ban (admin command). Add proper error handling, command cooldowns, and role-based permissions. Also include a basic setup guide."
                },
                { 
                    display: "Build a Portfolio Website",
                    text: "Help me create a modern portfolio website using HTML, CSS, and JavaScript. Include sections for About Me, Projects, Skills, and Contact. Make it responsive with animations, dark/light mode toggle, and a projects filter system. Add SEO optimization and performance best practices."
                },
                { 
                    display: "Create a REST API",
                    text: "Create a RESTful API using Node.js and Express with MongoDB as the database. Include user authentication with JWT, CRUD operations for posts/comments, input validation, error handling, rate limiting, and API documentation. Follow REST best practices and include security measures."
                },
                { 
                    display: "Build a Todo App",
                    text: "Create a full-stack todo application with React for frontend and Node.js for backend. Include features like task categories, due dates, priority levels, search/filter, and user authentication. Use MongoDB for storage and add real-time updates using WebSocket."
                },
                { 
                    display: "Create a Game in Python",
                    text: "Create a simple 2D game using Pygame. Make a platformer with a player character that can move, jump, and collect items. Include basic physics, collision detection, score system, multiple levels, and sound effects. Add a main menu and game over screen."
                },
                { 
                    display: "Build a Chrome Extension",
                    text: "Create a Chrome extension that helps with productivity. Features should include website blocking, pomodoro timer, task tracking, and custom notifications. Include local storage for settings, popup interface, and background scripts. Add sync functionality across devices."
                },
                { 
                    display: "Create a CLI Tool",
                    text: "Build a command-line interface tool using Python that helps developers automate common tasks. Include file operations, git integrations, project scaffolding, and configuration management. Add colorful output, progress bars, and interactive prompts. Make it installable via pip."
                },
                { 
                    display: "Build an AI Chatbot",
                    text: "Create an AI chatbot using Python and the OpenAI API. Include features like context management, conversation history, prompt templates, and response streaming. Add rate limiting, error handling, and a simple web interface. Include environment variable management and deployment instructions."
                }
            ],
            learning: [
                { 
                    display: "Explain Machine Learning",
                    text: "Explain machine learning concepts for beginners. Cover supervised vs unsupervised learning, common algorithms (linear regression, decision trees, neural networks), overfitting vs underfitting, training/testing data splits, and provide simple real-world examples for each concept."
                },
                { 
                    display: "Database Design Guide",
                    text: "Guide me through database design best practices. Explain normalization, indexing strategies, relationship types, query optimization, and when to use different types of databases (SQL vs NoSQL). Include practical examples and common pitfalls to avoid."
                },
                { 
                    display: "Learn System Design",
                    text: "Teach me system design fundamentals. Cover scalability, load balancing, caching strategies, database sharding, microservices architecture, API gateway patterns, and message queues. Use real-world examples like designing Twitter or Netflix."
                },
                { 
                    display: "Master Git Workflow",
                    text: "Explain professional Git workflow and best practices. Cover branching strategies, commit conventions, merge vs rebase, handling merge conflicts, Git hooks, and working with remote repositories. Include real-world team collaboration scenarios."
                },
                { 
                    display: "Learn Docker Basics",
                    text: "Teach me Docker fundamentals from scratch. Explain containers, images, Dockerfile syntax, Docker Compose, networking, volumes, and multi-stage builds. Include best practices for optimizing images and securing containers. Provide practical examples for development and production."
                },
                { 
                    display: "Understand Clean Code",
                    text: "Explain clean code principles and best practices. Cover SOLID principles, design patterns, code organization, naming conventions, and refactoring techniques. Provide examples in multiple programming languages and discuss common anti-patterns to avoid."
                },
                { 
                    display: "Learn Testing Strategies",
                    text: "Guide me through software testing best practices. Cover unit testing, integration testing, end-to-end testing, test-driven development (TDD), and behavior-driven development (BDD). Include examples using popular testing frameworks and discuss test coverage and mocking."
                },
                { 
                    display: "Master Regular Expressions",
                    text: "Teach me regular expressions from basic to advanced. Cover pattern matching, quantifiers, groups, lookaheads/lookbehinds, and flags. Include practical examples for validation, parsing, and text manipulation. Provide exercises and common regex patterns."
                }
            ],
            projects: [
                { 
                    display: "Weather App",
                    text: "Help me build a weather application that uses the OpenWeatherMap API. Include features like 5-day forecast, location search, temperature unit conversion, weather alerts, and responsive design. Add geolocation support and weather icons with animations."
                },
                { 
                    display: "Chat Application",
                    text: "Create a real-time chat application using WebSocket. Include features like private messaging, group chats, file sharing, emoji support, message history, and user presence indicators. Add message encryption and notification system."
                },
                { 
                    display: "E-commerce Platform",
                    text: "Build an e-commerce platform with product catalog, shopping cart, user authentication, order processing, and payment integration (Stripe). Include features like product search/filter, reviews, wishlist, and admin dashboard."
                },
                { 
                    display: "Blog Platform",
                    text: "Create a blog platform with user authentication, CRUD operations for posts, comments system, categories/tags, and markdown support. Add features like search functionality, social sharing, and an admin panel for content management."
                },
                { 
                    display: "Password Manager",
                    text: "Build a secure password manager application with encryption, password generation, secure storage, and browser integration. Include features like password strength analysis, two-factor authentication, secure notes, and automatic form filling."
                },
                { 
                    display: "Social Media Dashboard",
                    text: "Create a social media analytics dashboard that integrates with multiple platforms (Twitter, Instagram, Facebook). Include real-time metrics, data visualization, scheduled posts, and engagement tracking. Add export functionality and custom reporting."
                },
                { 
                    display: "File Sharing Service",
                    text: "Build a secure file sharing service with features like drag-and-drop upload, file encryption, expiring links, and access controls. Include large file support, progress tracking, and preview functionality for common file types."
                },
                { 
                    display: "Kanban Board",
                    text: "Create a Kanban board application like Trello with drag-and-drop functionality, real-time updates, and team collaboration features. Include task assignments, due dates, labels, attachments, and activity tracking."
                }
            ],
            problemSolving: [
                { 
                    display: "Optimize Database",
                    text: "Help me optimize my database performance. Current issues include slow query response times and high server load. Need help with query optimization, proper indexing strategies, caching implementation, and database normalization. Include monitoring and benchmarking approaches."
                },
                { 
                    display: "Debug Memory Leaks",
                    text: "Help identify and fix memory leaks in my Node.js application. Application memory usage grows over time and crashes. Need guidance on using memory profiling tools, common memory leak patterns, and best practices for memory management."
                },
                { 
                    display: "Improve API Performance",
                    text: "Optimize my REST API performance. Current issues include slow response times and high server load. Need help with implementing caching, pagination, rate limiting, and query optimization. Include monitoring and error handling improvements."
                },
                { 
                    display: "Fix Security Issues",
                    text: "Help me improve the security of my web application. Need guidance on implementing proper authentication, preventing XSS and CSRF attacks, securing API endpoints, implementing rate limiting, and following OWASP security best practices."
                },
                { 
                    display: "Solve Scaling Issues",
                    text: "Help me scale my web application to handle increased traffic. Need guidance on implementing horizontal scaling, load balancing, caching strategies, and database optimization. Include monitoring solutions and performance metrics."
                },
                { 
                    display: "Fix Frontend Performance",
                    text: "Help optimize my React application's performance. Issues include slow initial load, render bottlenecks, and memory usage. Need help with code splitting, lazy loading, memo/useMemo usage, and bundle size optimization."
                },
                { 
                    display: "Debug Authentication",
                    text: "Help fix issues with my authentication system. Problems include token management, session handling, and security vulnerabilities. Need guidance on implementing secure authentication flow, password reset, and social login integration."
                },
                { 
                    display: "Optimize Docker Setup",
                    text: "Help improve my Docker development and production setup. Need guidance on optimizing container builds, reducing image sizes, improving compose configuration, and implementing proper networking and volume management."
                }
            ]
        };

        function getRandomExample(category) {
            const examples = exampleMessages[category];
            return examples[Math.floor(Math.random() * examples.length)];
        }

        function createWelcomeMessage() {
            // Get random examples from each category
            const codingExample = getRandomExample('coding');
            const learningExample = getRandomExample('learning');
            const projectsExample = getRandomExample('projects');
            const problemSolvingExample = getRandomExample('problemSolving');

            return `
                <div class="welcome-content">
                    <i class="fa-solid fa-hexagon-nodes welcome-icon"></i>
                    <div class="welcome-title">Welcome to Gem Intellegence</div>
                    <div class="welcome-subtitle">What can we help you with today?</div>
                    <div class="welcome-features">
                        <div class="welcome-feature">
                            <i class="fas fa-code"></i>
                            <div class="welcome-feature-text">Expert coding assistance and problem-solving</div>
                        </div>
                        <div class="welcome-feature">
                            <i class="fas fa-brain"></i>
                            <div class="welcome-feature-text">Clear technical explanations and active learning</div>
                        </div>
                        <div class="welcome-feature">
                            <i class="fas fa-comments"></i>
                            <div class="welcome-feature-text">Natural conversation and friendly support</div>
                        </div>
                    </div>
                    <div class="example-messages">
                        <button class="example-message" onclick="useExampleMessage('${codingExample.text}')">
                            <i class="fas fa-code"></i>
                            <span>${codingExample.display}</span>
                        </button>
                        <button class="example-message" onclick="useExampleMessage('${learningExample.text}')">
                            <i class="fas fa-graduation-cap"></i>
                            <span>${learningExample.display}</span>
                        </button>
                        <button class="example-message" onclick="useExampleMessage('${projectsExample.text}')">
                            <i class="fas fa-laptop-code"></i>
                            <span>${projectsExample.display}</span>
                        </button>
                        <button class="example-message" onclick="useExampleMessage('${problemSolvingExample.text}')">
                            <i class="fas fa-brain"></i>
                            <span>${problemSolvingExample.display}</span>
                        </button>
                    </div>
                </div>
            `;
        }

        // Update createNewChat function to use the new welcome message
        function createNewChat() {
            // Remove empty chats except the current one
            chats = chats.filter(chat => 
                chat.messages.length > 0 || chat.id === currentChatId
            );
            
            // Check if there's already an empty chat
            const emptyChat = chats.find(chat => !chat.messages || chat.messages.length === 0);
            if (emptyChat) {
                currentChatId = emptyChat.id;
                chatHistory = [];
                
                // Get user preferences and update system instructions
                const savedPrefs = localStorage.getItem('gemi_user_preferences');
                if (savedPrefs) {
                    const prefs = JSON.parse(savedPrefs);
                    let customInstructions = DEFAULT_SYSTEM_INSTRUCTIONS;
                    
                    // Add communication style preferences
                    if (prefs.communicationStyle.includes('detailed')) {
                        customInstructions += '\nProvide detailed and comprehensive explanations.';
                    }
                    if (prefs.communicationStyle.includes('concise')) {
                        customInstructions += '\nFocus on brevity and clarity in responses.';
                    }
                    if (prefs.communicationStyle.includes('technical')) {
                        customInstructions += '\nUse technical terminology and in-depth explanations.';
                    }
                    if (prefs.communicationStyle.includes('casual')) {
                        customInstructions += '\nMaintain a friendly and conversational tone.';
                    }
                    
                    // Add user context
                    customInstructions += `\n\nUser Context:\nName: ${prefs.name}\nRole: ${prefs.role}\nInterests: ${prefs.interests.join(', ')}`;
                    
                    SYSTEM_INSTRUCTIONS = customInstructions;
                    emptyChat.systemInstructions = customInstructions;
                } else {
                    SYSTEM_INSTRUCTIONS = DEFAULT_SYSTEM_INSTRUCTIONS;
                    emptyChat.systemInstructions = DEFAULT_SYSTEM_INSTRUCTIONS;
                }
                
                updateCustomAIInfo();
                displayChatHistory();
                renderChatList();
                document.getElementById('currentChatTitle').textContent = 'New Chat';
                // Clear input and images
                document.getElementById('prompt').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                uploadedImages = [];
                updateSendButtonState();
                return;
            }

            const chatId = `chat_${Date.now()}`;
            
            // Get user preferences and create custom instructions
            const savedPrefs = localStorage.getItem('gemi_user_preferences');
            let systemInstructions = DEFAULT_SYSTEM_INSTRUCTIONS;
            
            if (savedPrefs) {
                const prefs = JSON.parse(savedPrefs);
                // Add communication style preferences
                if (prefs.communicationStyle.includes('detailed')) {
                    systemInstructions += '\nProvide detailed and comprehensive explanations.';
                }
                if (prefs.communicationStyle.includes('concise')) {
                    systemInstructions += '\nFocus on brevity and clarity in responses.';
                }
                if (prefs.communicationStyle.includes('technical')) {
                    systemInstructions += '\nUse technical terminology and in-depth explanations.';
                }
                if (prefs.communicationStyle.includes('casual')) {
                    systemInstructions += '\nMaintain a friendly and conversational tone.';
                }
                
                // Add user context
                systemInstructions += `\n\nUser Context:\nName: ${prefs.name}\nRole: ${prefs.role}\nInterests: ${prefs.interests.join(', ')}`;
            }
            
            const chat = {
                id: chatId,
                title: 'New Chat',
                messages: [],
                createdAt: new Date().toISOString(),
                systemInstructions: systemInstructions,
                pinned: false
            };
            
            chats.unshift(chat);
            currentChatId = chatId;
            chatHistory = [];
            SYSTEM_INSTRUCTIONS = systemInstructions;
            
            // Clear input and images
            document.getElementById('prompt').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            uploadedImages = [];
            updateSendButtonState();
            saveChats();
            updateCustomAIInfo();
            renderChatList();
            displayChatHistory();
            document.getElementById('currentChatTitle').textContent = 'New Chat';
        }

        function useExampleMessage(message) {
            const promptInput = document.getElementById('prompt');
            promptInput.value = message;
            promptInput.style.height = 'auto';
            promptInput.style.height = promptInput.scrollHeight + 'px';
            generateContent();
        }

        // Render chat list in sidebar
        function renderChatList() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            
            // Sort chats: pinned first, then by timestamp
            const sortedChats = [...chats].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                
                const aTime = a.messages.length > 0 ? new Date(a.messages[a.messages.length - 1].timestamp || 0) : new Date(0);
                const bTime = b.messages.length > 0 ? new Date(b.messages[b.messages.length - 1].timestamp || 0) : new Date(0);
                return bTime - aTime;
            });
            
            sortedChats.forEach((chat) => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''} ${isGenerating && chat.id !== currentChatId ? 'disabled' : ''}`;
                chatItem.setAttribute('data-chat-id', chat.id);
                chatItem.onclick = () => loadChat(chat.id);
                
                const icon = document.createElement('div');
                icon.className = 'chat-item-icon';
                icon.innerHTML = '<i class="fas fa-comments"></i>';
                
                const content = document.createElement('div');
                content.className = 'chat-item-content';
                
                const title = document.createElement('div');
                title.className = 'chat-item-title';
                title.textContent = chat.title;
                
                const preview = document.createElement('div');
                preview.className = 'chat-item-preview';
                const lastMessage = chat.messages[chat.messages.length - 1];
                preview.textContent = lastMessage ? lastMessage.parts[lastMessage.parts.length - 1].text.slice(0, 50) + '...' : 'No messages';
                
                // Add pin button
                const pinButton = document.createElement('button');
                pinButton.className = `chat-item-pin ${chat.pinned ? 'pinned' : ''}`;
                pinButton.innerHTML = `<i class="fas fa-thumbtack"></i>`;
                pinButton.setAttribute('title', chat.pinned ? 'Unpin chat' : 'Pin chat');
                pinButton.onclick = (e) => {
                    e.stopPropagation();
                    togglePinChat(chat.id);
                };
                
                content.appendChild(title);
                content.appendChild(preview);
                chatItem.appendChild(icon);
                chatItem.appendChild(content);
                chatItem.appendChild(pinButton);
                chatList.appendChild(chatItem);
            });
        }

        function togglePinChat(chatId) {
            const chatIndex = chats.findIndex(c => c.id === chatId);
            if (chatIndex !== -1) {
                chats[chatIndex].pinned = !chats[chatIndex].pinned;
                saveChats();
                renderChatList();
                showNotification(chats[chatIndex].pinned ? 'Chat pinned' : 'Chat unpinned');
            }
        }

        // Load a specific chat
        function loadChat(chatId) {
            if (isGenerating) return;
            
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                currentChatId = chatId;
                chatHistory = [...chat.messages];
                SYSTEM_INSTRUCTIONS = chat.systemInstructions || DEFAULT_SYSTEM_INSTRUCTIONS;
                document.getElementById('currentChatTitle').textContent = chat.title;
                // Clear input and images when switching chats
                document.getElementById('prompt').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                uploadedImages = [];
                updateSendButtonState();
                updateCustomAIInfo();
                displayChatHistory();
                renderChatList();
            }
        }

        // Save current chat
        function saveCurrentChat() {
            if (currentChatId) {
                const chatIndex = chats.findIndex(c => c.id === currentChatId);
                if (chatIndex !== -1) {
                    chats[chatIndex].messages = chatHistory;
                    updateChatListAndUI();
                }
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            
            if (window.innerWidth <= 768) {
                // Mobile behavior
                sidebar.classList.toggle('sidebar-expanded');
            } else {
                // Desktop behavior
                sidebar.classList.toggle('sidebar-collapsed');
            }
        }

        // Export chat
        function exportChat(format = 'markdown') {
            if (!chatHistory.length) return;

            let content = '';
            if (format === 'markdown') {
                content = chatHistory.map(msg => {
                    const role = msg.role === 'user' ? ' User' : ' Assistant';
                    return `### ${role}\n\n${msg.parts[msg.parts.length - 1].text}\n\n`;
                }).join('---\n\n');
            } else if (format === 'json') {
                content = JSON.stringify(chatHistory, null, 2);
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_export_${new Date().toISOString()}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showNotification(`Chat exported as ${format.toUpperCase()}`);
        }

        // Clear chat with custom modal
        function clearChat() {
            // If this is the only chat, just clear its messages
            if (chats.length === 1) {
                showModal(
                    'Clear Chat',
                    'Are you sure you want to clear the current chat? This action cannot be undone.',
                    'Clear',
                    'Cancel',
                    () => {
                        chatHistory = [];
                        const chatIndex = chats.findIndex(c => c.id === currentChatId);
                        if (chatIndex !== -1) {
                            // Get user preferences and create custom instructions
                            const savedPrefs = localStorage.getItem('gemi_user_preferences');
                            let systemInstructions = DEFAULT_SYSTEM_INSTRUCTIONS;
                            
                            if (savedPrefs) {
                                const prefs = JSON.parse(savedPrefs);
                                // Add communication style preferences
                                if (prefs.communicationStyle.includes('detailed')) {
                                    systemInstructions += '\nProvide detailed and comprehensive explanations.';
                                }
                                if (prefs.communicationStyle.includes('concise')) {
                                    systemInstructions += '\nFocus on brevity and clarity in responses.';
                                }
                                if (prefs.communicationStyle.includes('technical')) {
                                    systemInstructions += '\nUse technical terminology and in-depth explanations.';
                                }
                                if (prefs.communicationStyle.includes('casual')) {
                                    systemInstructions += '\nMaintain a friendly and conversational tone.';
                                }
                                
                                // Add user context
                                systemInstructions += `\n\nUser Context:\nName: ${prefs.name}\nRole: ${prefs.role}\nInterests: ${prefs.interests.join(', ')}`;
                            }

                            chats[chatIndex].messages = [];
                            chats[chatIndex].title = 'New Chat';
                            chats[chatIndex].systemInstructions = systemInstructions;
                            SYSTEM_INSTRUCTIONS = systemInstructions;
                            updateCustomAIInfo();
                            updateChatListAndUI();
                        }
                        document.getElementById('currentChatTitle').textContent = 'New Chat';
                        // Clear input and images
                        document.getElementById('prompt').value = '';
                        document.getElementById('imagePreview').innerHTML = '';
                        uploadedImages = [];
                        updateSendButtonState();
                        displayChatHistory();
                    }
                );
                return;
            }

            // If there are multiple chats, allow deletion
            showModal(
                'Clear Chat',
                'Are you sure you want to clear the current chat? This action cannot be undone.',
                'Clear',
                'Cancel',
                () => {
                    // Remove the current chat
                    const chatIndex = chats.findIndex(c => c.id === currentChatId);
                    if (chatIndex !== -1) {
                        chats.splice(chatIndex, 1);
                        
                        // Find the next available chat to load or create a new one with user preferences
                        if (chats.length > 0) {
                            // Try to load the chat that's now at the same index
                            // If not available, load the last chat
                            const nextChatIndex = Math.min(chatIndex, chats.length - 1);
                            currentChatId = chats[nextChatIndex].id;
                            chatHistory = [...chats[nextChatIndex].messages];
                            SYSTEM_INSTRUCTIONS = chats[nextChatIndex].systemInstructions || DEFAULT_SYSTEM_INSTRUCTIONS;
                            document.getElementById('currentChatTitle').textContent = chats[nextChatIndex].title;
                        } else {
                            // Create a new chat with user preferences
                            const savedPrefs = localStorage.getItem('gemi_user_preferences');
                            let systemInstructions = DEFAULT_SYSTEM_INSTRUCTIONS;
                            
                            if (savedPrefs) {
                                const prefs = JSON.parse(savedPrefs);
                                // Add communication style preferences
                                if (prefs.communicationStyle.includes('detailed')) {
                                    systemInstructions += '\nProvide detailed and comprehensive explanations.';
                                }
                                if (prefs.communicationStyle.includes('concise')) {
                                    systemInstructions += '\nFocus on brevity and clarity in responses.';
                                }
                                if (prefs.communicationStyle.includes('technical')) {
                                    systemInstructions += '\nUse technical terminology and in-depth explanations.';
                                }
                                if (prefs.communicationStyle.includes('casual')) {
                                    systemInstructions += '\nMaintain a friendly and conversational tone.';
                                }
                                
                                // Add user context
                                systemInstructions += `\n\nUser Context:\nName: ${prefs.name}\nRole: ${prefs.role}\nInterests: ${prefs.interests.join(', ')}`;
                            }

                            const newChat = {
                                id: `chat_${Date.now()}`,
                                title: 'New Chat',
                                messages: [],
                                createdAt: new Date().toISOString(),
                                systemInstructions: systemInstructions,
                                pinned: false
                            };
                            
                            chats.push(newChat);
                            currentChatId = newChat.id;
                            chatHistory = [];
                            SYSTEM_INSTRUCTIONS = systemInstructions;
                            document.getElementById('currentChatTitle').textContent = 'New Chat';
                        }
                        
                        // Clear input and images
                        document.getElementById('prompt').value = '';
                        document.getElementById('imagePreview').innerHTML = '';
                        uploadedImages = [];
                        updateSendButtonState();
                        updateCustomAIInfo();
                        saveChats();
                        renderChatList();
                        displayChatHistory();
                    }
                }
            );
        }

        // Command palette
        const commands = [
            { id: 'new_chat', title: 'New Chat', description: 'Start a new conversation', icon: 'plus', shortcut: 'Ctrl+N', action: createNewChat },
            { id: 'export_md', title: 'Export as Markdown', description: 'Export chat as Markdown file', icon: 'file-alt', shortcut: 'Ctrl+E', action: () => exportChat('markdown') },
            { id: 'export_json', title: 'Export as JSON', description: 'Export chat as JSON file', icon: 'file-code', shortcut: 'Ctrl+J', action: () => exportChat('json') },
            { id: 'clear_chat', title: 'Clear Chat', description: 'Clear current conversation', icon: 'trash', shortcut: 'Ctrl+Del', action: clearChat },
            { id: 'toggle_theme', title: 'Toggle Theme', description: 'Switch between dark and light theme', icon: 'moon', shortcut: 'Ctrl+T', action: toggleTheme },
            { id: 'toggle_sidebar', title: 'Toggle Sidebar', description: 'Show/hide sidebar', icon: 'bars', shortcut: 'Ctrl+B', action: toggleSidebar },
        ];

        function showCommandPalette() {
            const palette = document.getElementById('commandPalette');
            const input = document.getElementById('commandInput');
            palette.classList.add('active');
            input.value = '';
            input.focus();
            renderCommands();

            // Add click event listener to document
            document.addEventListener('click', handleClickOutside);
        }

        function hideCommandPalette() {
            const palette = document.getElementById('commandPalette');
            palette.classList.remove('active');
            // Remove click event listener from document
            document.removeEventListener('click', handleClickOutside);
        }

        // Function to handle clicks outside the command palette
        function handleClickOutside(event) {
            const palette = document.getElementById('commandPalette');
            const openCommandsBtn = document.getElementById('openCommands');
            
            // Check if the click is outside both the palette and the open commands button
            if (!palette.contains(event.target) && !openCommandsBtn.contains(event.target)) {
                hideCommandPalette();
            }
        }

        function renderCommands(filter = '') {
            const commandList = document.getElementById('commandList');
            commandList.innerHTML = '';
            
            const filteredCommands = commands.filter(cmd => 
                cmd.title.toLowerCase().includes(filter.toLowerCase()) ||
                cmd.description.toLowerCase().includes(filter.toLowerCase())
            );

            filteredCommands.forEach(cmd => {
                const item = document.createElement('div');
                item.className = 'command-item';
                item.innerHTML = `
                    <div class="command-icon">
                        <i class="fas fa-${cmd.icon}"></i>
                    </div>
                    <div class="command-info">
                        <div class="command-title">${cmd.title}</div>
                        <div class="command-description">${cmd.description}</div>
                    </div>
                    <div class="command-shortcut">${cmd.shortcut}</div>
                `;
                item.onclick = () => {
                    cmd.action();
                    hideCommandPalette();
                };
                commandList.appendChild(item);
            });
        }

        // Custom modal functions
        function showModal(title, content, confirmText, cancelText, onConfirm, onCancel) {
            const overlay = document.getElementById('modalOverlay');
            const titleEl = document.getElementById('modalTitle');
            const contentEl = document.getElementById('modalContent');
            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');

            titleEl.textContent = title;
            contentEl.innerHTML = content;
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;

            overlay.style.display = 'flex';

            // Remove any existing event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            newConfirmBtn.onclick = () => {
                overlay.style.display = 'none';
                onConfirm?.();
            };

            newCancelBtn.onclick = () => {
                overlay.style.display = 'none';
                onCancel?.();
            };

            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                    onCancel?.();
                }
            };
        }

        // Event listeners
        document.getElementById('toggleTheme').onclick = toggleTheme;
        document.getElementById('toggleSidebar').onclick = toggleSidebar;
        document.getElementById('clearChat').onclick = clearChat;
        document.querySelector('.new-chat-btn').onclick = createNewChat;
        document.getElementById('stopGenerate').onclick = stopGeneration;

        // Modify existing generateContent function
        const originalGenerateContent = generateContent;
        generateContent = async function(isRegeneration = false) {
            await originalGenerateContent(isRegeneration);
            if (!isRegeneration) {
                // Add timestamp to the last message
                if (chatHistory.length > 0) {
                    chatHistory[chatHistory.length - 1].timestamp = new Date().toISOString();
                }
                saveCurrentChat();
                // Move current chat to top
                const currentChatIndex = chats.findIndex(c => c.id === currentChatId);
                if (currentChatIndex > 0) {
                    const [chat] = chats.splice(currentChatIndex, 1);
                    chats.unshift(chat);
                    saveChats();
                    renderChatList();
                }
            }
        };

        // Initialize
        loadCustomAIs();
        loadChats();
        if (!currentChatId) {
            createNewChat();
        } else {
            // Update Gem Int info for the current chat
            updateCustomAIInfo();
        }

        // Update UI for generation state
        function updateGeneratingState(generating) {
            isGenerating = generating;
            document.getElementById('stopGenerate').classList.toggle('visible', generating);
            
            // Update send button state
            if (!generating) {
                updateSendButtonState();
            } else {
                document.querySelector('.send-button').disabled = true;
            }
            
            // Disable chat items
            document.querySelectorAll('.chat-item').forEach(item => {
                if (item.getAttribute('data-chat-id') !== currentChatId) {
                    item.classList.toggle('disabled', generating);
                }
            });
            
            // Disable new chat button
            document.querySelector('.new-chat-btn').classList.toggle('disabled', generating);
            
            // Disable header action buttons except theme toggle and sidebar
            document.querySelectorAll('.header-actions .sidebar-action-btn').forEach(btn => {
                if (!btn.id.includes('toggleTheme') && !btn.id.includes('toggleSidebar')) {
                    btn.classList.toggle('disabled', generating);
                    btn.style.pointerEvents = generating ? 'none' : 'auto';
                }
            });
            
            // Disable custom AI section
            document.querySelectorAll('.custom-ai-item, .custom-ai-add').forEach(element => {
                element.classList.toggle('disabled', generating);
                element.style.pointerEvents = generating ? 'none' : 'auto';
            });
            
            // Disable clear chat functionality
            const clearChatBtn = document.getElementById('clearChat');
            if (clearChatBtn) {
                clearChatBtn.classList.toggle('disabled', generating);
                clearChatBtn.style.pointerEvents = generating ? 'none' : 'auto';
            }
            
            // Add CSS for disabled state if not already present
            if (!document.getElementById('disabledStyles')) {
                const style = document.createElement('style');
                style.id = 'disabledStyles';
                style.textContent = `
                    .disabled {
                        opacity: 0.5;
                        cursor: not-allowed !important;
                    }
                    .sidebar-action-btn.disabled,
                    .custom-ai-item.disabled,
                    .custom-ai-add.disabled {
                        opacity: 0.5;
                        pointer-events: none;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Stop generation
        async function stopGeneration() {
            if (currentReader) {
                await currentReader.cancel();
                currentReader = null;
            }
            updateGeneratingState(false);
        }

        // Update chat list and UI
        function updateChatListAndUI() {
            // Sort chats by last message timestamp
            chats.sort((a, b) => {
                const aTime = a.messages.length > 0 ? new Date(a.messages[a.messages.length - 1].timestamp || 0) : new Date(0);
                const bTime = b.messages.length > 0 ? new Date(b.messages[b.messages.length - 1].timestamp || 0) : new Date(0);
                return bTime - aTime;
            });

            // Update chat titles
            chats.forEach(chat => {
                if (chat.messages && chat.messages.length > 0) {
                    const firstMessage = chat.messages[0].parts[chat.messages[0].parts.length - 1].text;
                    chat.title = firstMessage.slice(0, 30) + (firstMessage.length > 30 ? '...' : '');
                }
            });

            // Save and render
            saveChats();
            renderChatList();

            // Update current chat title if needed
            if (currentChatId) {
                const currentChat = chats.find(c => c.id === currentChatId);
                if (currentChat) {
                    document.getElementById('currentChatTitle').textContent = 
                        currentChat.messages.length > 0 ? currentChat.title : 'New Chat';
                }
            }
        }

        function loadCustomAIs() {
            const savedAIs = localStorage.getItem('gemi_custom_ais');
            if (savedAIs) {
                customAIs = JSON.parse(savedAIs);
                renderCustomAIs();
            }
        }

        function saveCustomAIs() {
            localStorage.setItem('gemi_custom_ais', JSON.stringify(customAIs));
        }

        function renderCustomAIs() {
            const container = document.getElementById('customAIList');
            container.innerHTML = '';

            customAIs.forEach((ai, index) => {
                const item = document.createElement('div');
                item.className = 'custom-ai-item';
                item.innerHTML = `
                    <i class="fa-solid fa-hexagon-nodes"></i>
                    <div class="custom-ai-item-name">${ai.name}</div>
                    <div class="custom-ai-actions">
                        <button class="custom-ai-action edit" title="Edit AI" onclick="event.stopPropagation(); editCustomAI(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="custom-ai-action delete" title="Delete AI" onclick="event.stopPropagation(); deleteCustomAI(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                item.onclick = () => createNewChatWithAI(ai);
                container.appendChild(item);
            });
        }

        function deleteCustomAI(index) {
            const ai = customAIs[index];
            
            // Find all chats using this AI
            const affectedChats = chats.filter(chat => chat.systemInstructions === ai.instructions);
            
            let warningMessage = `Are you sure you want to delete "${ai.name}"? This action cannot be undone.`;
            
            if (affectedChats.length > 0) {
                warningMessage += `\n\nThe following chats will also be deleted:\n`;
                affectedChats.forEach(chat => {
                    warningMessage += `\n ${chat.title}`;
                });
            }

            showModal(
                'Delete Gem Int',
                warningMessage.replace(/\n/g, '<br>'),
                'Delete',
                'Cancel',
                () => {
                    // Remove the AI
                    customAIs.splice(index, 1);
                    saveCustomAIs();
                    renderCustomAIs();

                    // Remove affected chats
                    if (affectedChats.length > 0) {
                        chats = chats.filter(chat => chat.systemInstructions !== ai.instructions);
                        saveChats();
                        
                        // If current chat was deleted, load another chat or create new one
                        if (affectedChats.some(chat => chat.id === currentChatId)) {
                            if (chats.length > 0) {
                                loadChat(chats[0].id);
                            } else {
                                createNewChat();
                            }
                        }
                        
                        renderChatList();
                    }

                    showNotification(`Deleted "${ai.name}" and ${affectedChats.length} associated chat${affectedChats.length !== 1 ? 's' : ''}`);
                }
            );
        }

        function showCustomAIModal() {
            const modalContent = `
                <div class="custom-ai-modal">
                    <div>
                        <label>AI Name</label>
                        <input type="text" id="aiName" placeholder="Enter a name for your AI" maxlength="50">
                    </div>
                    <div>
                        <label>System Instructions</label>
                        <textarea id="aiInstructions" placeholder="Enter detailed instructions for how your AI should behave, its personality, knowledge, and limitations." rows="8"></textarea>
                        <div class="tip">
                            Tip: Be specific about the AI's role, personality, and how it should interact. The instructions will be used for every message in chats with this AI.
                        </div>
                    </div>
                </div>
            `;

            showModal(
                'Create Gem Int',
                modalContent,
                'Create',
                'Cancel',
                () => {
                    const name = document.getElementById('aiName').value.trim();
                    const instructions = document.getElementById('aiInstructions').value.trim();
                    
                    if (name && instructions) {
                        if (customAIs.some(ai => ai.name === name)) {
                            showNotification('An AI with this name already exists');
                            return;
                        }
                        customAIs.push({ name, instructions });
                        saveCustomAIs();
                        renderCustomAIs();
                        createNewChatWithAI(customAIs[customAIs.length - 1]);
                        showNotification(`Created new AI: ${name}`);
                    } else {
                        showNotification('Please fill in both name and instructions');
                    }
                }
            );
        }

        function createNewChatWithAI(ai) {
            chats = chats.filter(chat => chat.messages && chat.messages.length > 0);
            
            const chatId = `chat_${Date.now()}`;
            const chat = {
                id: chatId,
                title: `Chat with ${ai.name}`,
                messages: [],
                createdAt: new Date().toISOString(),
                systemInstructions: ai.instructions,
                pinned: false  // Add pinned property
            };
            
            chats.unshift(chat);
            currentChatId = chatId;
            chatHistory = [];
            SYSTEM_INSTRUCTIONS = ai.instructions;
            
            // Clear input and images when creating new AI chat
            document.getElementById('prompt').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            uploadedImages = [];
            updateSendButtonState();
            saveChats();
            updateCustomAIInfo();
            renderChatList();
            displayChatHistory();
            document.getElementById('currentChatTitle').textContent = `Chat with ${ai.name}`;

            // Add simplified welcome message for custom AI
            const chatHistoryDiv = document.getElementById('chatHistory');
            chatHistoryDiv.innerHTML = `
                <div class="welcome-container">
                    <div class="welcome-content">
                        <div class="welcome-title">Chat with ${ai.name}</div>
                        <div class="welcome-footer">Start typing below to begin your conversation</div>
                    </div>
                </div>
            `;
        }

        function editCustomAI(index) {
            const ai = customAIs[index];
            const modalContent = `
                <div class="custom-ai-modal">
                    <div>
                        <label>AI Name</label>
                        <input type="text" id="aiName" placeholder="Enter a name for your AI" maxlength="50" value="${ai.name}">
                    </div>
                    <div>
                        <label>System Instructions</label>
                        <textarea id="aiInstructions" placeholder="Enter detailed instructions for how your AI should behave, its personality, knowledge, and limitations." rows="8">${ai.instructions}</textarea>
                        <div class="tip">
                            Tip: Be specific about the AI's role, personality, and how it should interact. The instructions will be used for every message in chats with this AI.
                        </div>
                    </div>
                </div>
            `;

            showModal(
                'Edit Gem Int',
                modalContent,
                'Save',
                'Cancel',
                () => {
                    const name = document.getElementById('aiName').value.trim();
                    const instructions = document.getElementById('aiInstructions').value.trim();
                    
                    if (name && instructions) {
                        if (name !== ai.name && customAIs.some(existingAI => existingAI.name === name)) {
                            showNotification('An AI with this name already exists');
                            return;
                        }
                        customAIs[index] = { name, instructions };
                        saveCustomAIs();
                        renderCustomAIs();
                        showNotification(`Updated "${name}"`);

                        // Update any existing chats using this AI
                        chats.forEach(chat => {
                            if (chat.systemInstructions === ai.instructions) {
                                chat.systemInstructions = instructions;
                                if (chat.title.startsWith('Chat with ' + ai.name)) {
                                    chat.title = 'Chat with ' + name;
                                }
                            }
                        });
                        saveChats();
                        
                        // Update current chat if it's using this AI
                        if (currentChatId) {
                            const currentChat = chats.find(c => c.id === currentChatId);
                            if (currentChat && currentChat.systemInstructions === ai.instructions) {
                                SYSTEM_INSTRUCTIONS = instructions;
                                updateCustomAIInfo();
                            }
                        }
                        
                        renderChatList();
                    } else {
                        showNotification('Please fill in both name and instructions');
                    }
                }
            );
        }

        function updateCustomAIInfo() {
            const infoDiv = document.getElementById('customAIInfo');
            const currentChat = chats.find(c => c.id === currentChatId);
            
            if (currentChat && currentChat.systemInstructions !== DEFAULT_SYSTEM_INSTRUCTIONS) {
                const customAI = customAIs.find(ai => ai.instructions === currentChat.systemInstructions);
                if (customAI) {
                    infoDiv.style.display = 'flex';
                    infoDiv.querySelector('span').textContent = customAI.name;
                } else {
                    infoDiv.style.display = 'none';
                }
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Remove the format buttons and message preview references
        const keyboardShortcuts = {
            'ctrl+n': { action: createNewChat, description: 'Create new chat' },
            'ctrl+i': { action: () => document.getElementById('imageInput').click(), description: 'Upload image' },
            'ctrl+enter': { action: generateContent, description: 'Send message' },
            'ctrl+b': { action: toggleSidebar, description: 'Toggle sidebar' },
            'ctrl+/': { action: showKeyboardShortcuts, description: 'Show keyboard shortcuts' },
            'esc': { action: () => {
                document.getElementById('prompt').value = '';
                updateSendButtonState();
            }, description: 'Clear input' }
        };

        // Add keyboard shortcuts modal
        function showKeyboardShortcuts() {
            const shortcutsList = Object.entries(keyboardShortcuts)
                .map(([key, { description }]) => `
                    <div class="shortcut-item">
                        <span class="shortcut-key">${key.toUpperCase()}</span>
                        <span class="shortcut-description">${description}</span>
                    </div>
                `).join('');

            showModal(
                'Keyboard Shortcuts',
                `<div class="shortcuts-container">${shortcutsList}</div>`,
                'Close',
                '',
                null,
                null
            );
        }

        // Add styles for new features
        const style = document.createElement('style');
        style.textContent = `
            .shortcuts-container {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                max-height: 400px;
                overflow-y: auto;
            }

            .shortcut-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0.5rem;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 6px;
            }

            .shortcut-key {
                background: var(--google-gradient);
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
                font-family: monospace;
                font-size: 0.875rem;
            }

            .shortcut-description {
                color: var(--text-primary);
                opacity: 0.8;
            }

            /* Accessibility improvements */
            .visually-hidden {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                border: 0;
            }

            /* High contrast focus indicators */
            button:focus-visible,
            input:focus-visible,
            textarea:focus-visible {
                outline: 2px solid #fff;
                outline-offset: 2px;
            }

            /* Skip to main content link */
            .skip-link {
                position: absolute;
                top: -40px;
                left: 0;
                background: var(--google-gradient);
                color: white;
                padding: 8px;
                z-index: 100;
                transition: top 0.2s;
            }

            .skip-link:focus {
                top: 0;
            }

            /* Improved button focus states */
            .sidebar-action-btn:focus-visible,
            .custom-ai-action:focus-visible {
                outline: 2px solid #fff;
                outline-offset: 2px;
            }

            /* Drag and drop styles */
            .drag-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                backdrop-filter: blur(4px);
            }

            .drag-overlay.active {
                display: flex;
            }

            .drag-message {
                padding: 2rem;
                border: 2px dashed rgba(255, 255, 255, 0.3);
                border-radius: 12px;
                color: white;
                font-size: 1.25rem;
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .drag-message i {
                font-size: 2rem;
                background: var(--google-gradient);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
        `;
        document.head.appendChild(style);

        // Add keyboard shortcut listener
        document.addEventListener('keydown', function(e) {
            // Don't trigger shortcuts when typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    generateContent();
                }
                return;
            }

            const key = `${e.ctrlKey ? 'ctrl+' : ''}${e.key.toLowerCase()}`;
            const shortcut = keyboardShortcuts[key];
            
            if (shortcut) {
                e.preventDefault();
                shortcut.action();
            }
        });

        // Add drag overlay to the DOM
        const dragOverlay = document.createElement('div');
        dragOverlay.className = 'drag-overlay';
        dragOverlay.innerHTML = `
            <div class="drag-message">
                <i class="fas fa-cloud-upload-alt"></i>
                Drop images here
            </div>
        `;
        document.body.appendChild(dragOverlay);

        // Add skip link for accessibility
        const skipLink = document.createElement('a');
        skipLink.href = '#chatHistory';
        skipLink.className = 'skip-link';
        skipLink.textContent = 'Skip to main content';
        document.body.insertBefore(skipLink, document.body.firstChild);

        // Add ARIA labels and roles
        document.querySelector('.chat-container').setAttribute('role', 'main');
        document.querySelector('.sidebar').setAttribute('role', 'navigation');
        document.querySelector('.chat-history').setAttribute('role', 'log');
        document.querySelector('.input-container').setAttribute('role', 'form');

        // Add drag and drop handling
        const dropZone = document.body;
        
        dropZone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            if (e.dataTransfer.types.includes('Files')) {
                dragOverlay.classList.add('active');
            }
        });

        dragOverlay.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        dragOverlay.addEventListener('dragleave', (e) => {
            e.preventDefault();
            if (e.relatedTarget === null) {
                dragOverlay.classList.remove('active');
            }
        });

        dragOverlay.addEventListener('drop', async (e) => {
            e.preventDefault();
            dragOverlay.classList.remove('active');
            
            const files = Array.from(e.dataTransfer.files).filter(file => 
                file.type.startsWith('image/')
            );

            if (files.length >0) {
                await handleImageFiles(files);
            }
        });

        // Add clipboard paste handling
        document.addEventListener('paste', async (e) => {
            const items = Array.from(e.clipboardData.items);
            const imageItems = items.filter(item => item.type.startsWith('image/'));
            
            if (imageItems.length >0) {
                e.preventDefault();
                const files = imageItems.map(item => item.getAsFile());
                await handleImageFiles(files);
            }
        });

        // Initialize message limit tracking
        loadDailyMessageCount();

        // Update message count display
        function updateMessageCountDisplay() {
            const remainingMessages = MESSAGE_LIMIT_PER_DAY - dailyMessageCount;
            const messageCountSpan = document.querySelector('#messageCountInfo span');
            messageCountSpan.textContent = `${remainingMessages}/${MESSAGE_LIMIT_PER_DAY} messages left today`;
            
            // Add warning class if running low on messages
            const messageCountInfo = document.getElementById('messageCountInfo');
            messageCountInfo.className = 'header-ai-info ' + 
                (remainingMessages <= 2 ? 'warning' : '') +
                (remainingMessages === 0 ? 'danger' : '');
        }

        // Add touch event handlers for swipe
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        function handleSwipe() {
            const sidebar = document.querySelector('.sidebar');
            const swipeDistance = Math.abs(touchEndX - touchStartX);
            const isSwipe = swipeDistance > 50; // Minimum swipe distance

            if (isSwipe) {
                if (touchEndX < touchStartX) { // Swipe left
                    if (sidebar.classList.contains('sidebar-expanded')) {
                        toggleSidebar();
                    }
                } else { // Swipe right
                    if (!sidebar.classList.contains('sidebar-expanded') && touchStartX < 50) {
                        toggleSidebar();
                    }
                }
            }
        }

        // Add splash screen logic at the start of the script
        function showIntro() {
            if (!localStorage.getItem('gemi_visited')) {
                const splashScreen = document.getElementById('splashScreen');
                const setupSteps = document.getElementById('setupSteps');
                
                // Show initial splash for 3 seconds
                setTimeout(() => {
                    // Fade out the initial splash content
                    const splashLogo = document.querySelector('.splash-logo');
                    const splashTitle = document.querySelector('.splash-title');
                    const splashSubtitle = document.querySelector('.splash-subtitle');
                    
                    splashLogo.style.opacity = '0';
                    splashTitle.style.opacity = '0';
                    splashSubtitle.style.opacity = '0';
                    
                    // Show setup steps after fade out
                    setTimeout(() => {
                        splashLogo.style.display = 'none';
                        splashTitle.style.display = 'none';
                        splashSubtitle.style.display = 'none';
                        
                        setupSteps.style.display = 'flex';
                        setTimeout(() => {
                            setupSteps.style.opacity = '1';
                            updateStep(1);
                        }, 100);
                    }, 500);
                }, 3000);
            } else {
                // Remove splash screen immediately if not first visit
                const splashScreen = document.getElementById('splashScreen');
                splashScreen.remove();
            }
        }

        // Update the setup steps initial styles
        const setupStyles = document.createElement('style');
        setupStyles.textContent = `
            .setup-steps {
                display: none;
                flex-direction: column;
                gap: 1rem;
                opacity: 0;
                transition: opacity 0.5s ease;
            }

            .splash-logo,
            .splash-title,
            .splash-subtitle {
                transition: opacity 0.3s ease;
            }
        `;
        document.head.appendChild(setupStyles);

        // Add validation and loading state to the setup buttons
        function nextStep() {
            if (validateStep(currentStep)) {
                const currentStepEl = document.querySelector(`.setup-step[data-step="${currentStep}"]`);
                const nextStepEl = document.querySelector(`.setup-step[data-step="${currentStep + 1}"]`);
                
                if (currentStepEl && nextStepEl && currentStep < totalSteps) {
                    currentStepEl.classList.add('slide-out');
                    
                    setTimeout(() => {
                        currentStepEl.style.display = 'none';
                        currentStepEl.classList.remove('active', 'slide-out');
                        nextStepEl.style.display = 'block';
                        nextStepEl.classList.add('active', 'slide-in');
                        
                        setTimeout(() => {
                            nextStepEl.classList.remove('slide-in');
                        }, 500);
                        
                        currentStep++;
                        updateProgress();
                        validateStep(currentStep);
                    }, 500);
                }
            }
        }

        // Update the completeSetup function
        function completeSetup() {
            const button = document.querySelector('.setup-button.primary');
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Setting up...';
            button.disabled = true;

            // Save user preferences
            if (userPreferences.saveInfo) {
                localStorage.setItem('gemi_user_preferences', JSON.stringify(userPreferences));
            }
            
            // Update system instructions based on preferences
            updateSystemInstructions();
            
            // Complete setup with a loading animation
            setTimeout(() => {
                const splashScreen = document.getElementById('splashScreen');
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.remove();
                    localStorage.setItem('gemi_visited', 'true');
                    
                    // Create initial chat with user preferences
                    createNewChat();
                }, 500);
            }, 1000);
        }

        // Add loading spinner styles
        const spinnerStyles = document.createElement('style');
        spinnerStyles.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .fa-spin {
                animation: spin 1s linear infinite;
            }

            .setup-button:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }
        `;
        document.head.appendChild(spinnerStyles);

        // ... rest of existing code ...
        let currentStep = 1;
        const totalSteps = 11;

        function updateStep(step) {
            document.querySelectorAll('.setup-step').forEach(s => {
                s.classList.remove('active');
            });
            document.querySelector(`.setup-step[data-step="${step}"]`).classList.add('active');
            
            // Update progress dots
            document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index < step);
            });
        }

        function prevStep() {
            if (currentStep > 1) {
                const currentStepEl = document.querySelector(`.setup-step[data-step="${currentStep}"]`);
                const prevStepEl = document.querySelector(`.setup-step[data-step="${currentStep - 1}"]`);
                
                if (currentStepEl && prevStepEl) {
                    currentStepEl.classList.add('slide-out');
                    
                    setTimeout(() => {
                        currentStepEl.style.display = 'none';
                        currentStepEl.classList.remove('active', 'slide-out');
                        prevStepEl.style.display = 'block';
                        prevStepEl.classList.add('active', 'slide-in');
                        
                        setTimeout(() => {
                            prevStepEl.classList.remove('slide-in');
                        }, 500);
                        
                        currentStep--;
                        updateProgress();
                        validateStep(currentStep);
                    }, 500);
                }
            }
        }

        function updateButtons() {
            const backButton = document.querySelector('#setupButtons .setup-button.secondary');
            const continueButton = document.querySelector('#setupButtons .setup-button.primary');
            
            // Show/hide back button based on current step
            backButton.style.display = currentStep === 1 ? 'none' : 'flex';
            
            // Update continue button text and functionality for final step
            if (currentStep === totalSteps) {
                continueButton.innerHTML = '<i class="fas fa-check"></i> Complete Setup';
                continueButton.onclick = () => {
                    completeSetup();
                    return false;
                };
            } else {
                continueButton.innerHTML = 'Continue <i class="fas fa-arrow-right"></i>';
                continueButton.onclick = () => {
                    nextStep();
                    return false;
                };
            }
            
            // Validate current step
            validateStep(currentStep);
        }

        // Call showIntro when the page loads
        document.addEventListener('DOMContentLoaded', showIntro);

        // Add styles for setup transitions
        const setupTransitionStyles = document.createElement('style');
        setupTransitionStyles.textContent = `
            .splash-logo, .splash-title, .splash-subtitle {
                transition: opacity 0.5s ease;
            }
            
            .setup-steps {
                opacity: 0;
                transition: opacity 0.5s ease;
            }
            
            .setup-step {
                display: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .setup-step.active {
                display: block;
                opacity: 1;
            }
        `;
        document.head.appendChild(setupTransitionStyles);

        let userPreferences = {
            name: '',
            role: '',
            experience: '',
            goals: '',
            theme: 'dark',
            enableAnimations: true,
            interests: [],
            preferences: [],
            communicationStyle: [],
            responsePreferences: [],
            learningStyle: [],
            developmentTools: [],
            saveInfo: false
        };

        function togglePreference(element) {
            element.classList.toggle('selected');
            const value = element.getAttribute('data-value');
            const step = element.closest('.setup-step').getAttribute('data-step');
            let category;
            
            switch(step) {
                case '5':
                    category = 'interests';
                    break;
                case '6':
                    category = 'preferences';
                    break;
                case '7':
                    category = 'communicationStyle';
                    break;
                case '8':
                    category = 'responsePreferences';
                    break;
                case '9':
                    category = 'learningStyle';
                    break;
                case '10':
                    category = 'developmentTools';
                    break;
                default:
                    return;
            }
            
            if (element.classList.contains('selected')) {
                if (!userPreferences[category].includes(value)) {
                    userPreferences[category].push(value);
                }
            } else {
                userPreferences[category] = userPreferences[category].filter(v => v !== value);
            }
            
            validateStep(parseInt(step));
        }

        function validateStep(step) {
            let isValid = true;
            const continueButton = document.querySelector('#setupButtons .setup-button.primary');

            switch(parseInt(step)) {
                case 1:
                    isValid = true;  // First step is always valid
                    break;
                case 2:
                    const name = document.getElementById('userName').value.trim();
                    const role = document.getElementById('userRole').value.trim();
                    isValid = name && role;
                    
                    if (isValid) {
                        userPreferences.name = name;
                        userPreferences.role = role;
                    }
                    break;
                case 3:
                    const experience = document.getElementById('userExperience').value.trim();
                    const goals = document.getElementById('userGoals').value.trim();
                    isValid = experience && goals;
                    
                    if (isValid) {
                        userPreferences.experience = experience;
                        userPreferences.goals = goals;
                    }
                    break;
                case 4:
                    isValid = true;  // Theme selection is always valid
                    break;
                case 5:
                    isValid = userPreferences.interests.length > 0;
                    break;
                case 6:
                    isValid = userPreferences.preferences.length > 0;
                    break;
                case 7:
                    isValid = userPreferences.communicationStyle.length > 0;
                    break;
                case 8:
                    isValid = userPreferences.responsePreferences.length > 0;
                    break;
                case 9:
                    isValid = userPreferences.learningStyle.length > 0;
                    break;
                case 10:
                    isValid = userPreferences.developmentTools.length > 0;
                    break;
                case 11:
                    isValid = true;  // Final step is always valid
                    break;
            }

            if (continueButton) {
                continueButton.disabled = !isValid;
            }
            return isValid;
        }

        // Add input event listeners for real-time validation
        document.addEventListener('DOMContentLoaded', () => {
            // Input validation for text fields
            const inputs = ['userName', 'userRole', 'userExperience', 'userGoals'];
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', () => {
                        validateStep(currentStep);
                    });
                }
            });

            // Initial validation for first step
            validateStep(1);
        });

        function nextStep() {
            if (validateStep(currentStep)) {
                if (currentStep === totalSteps) {
                    completeSetup();
                    return;
                }
                
                const currentStepEl = document.querySelector(`.setup-step[data-step="${currentStep}"]`);
                const nextStepEl = document.querySelector(`.setup-step[data-step="${currentStep + 1}"]`);
                
                if (currentStepEl && nextStepEl && currentStep < totalSteps) {
                    currentStepEl.classList.add('slide-out');
                    
                    setTimeout(() => {
                        currentStepEl.style.display = 'none';
                        currentStepEl.classList.remove('active', 'slide-out');
                        nextStepEl.style.display = 'block';
                        nextStepEl.classList.add('active', 'slide-in');
                        
                        setTimeout(() => {
                            nextStepEl.classList.remove('slide-in');
                        }, 500);
                        
                        currentStep++;
                        updateProgress();
                        updateButtons();
                        validateStep(currentStep);
                    }, 500);
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                const currentStepEl = document.querySelector(`.setup-step[data-step="${currentStep}"]`);
                const prevStepEl = document.querySelector(`.setup-step[data-step="${currentStep - 1}"]`);
                
                if (currentStepEl && prevStepEl) {
                    currentStepEl.classList.add('slide-out');
                    
                    setTimeout(() => {
                        currentStepEl.style.display = 'none';
                        currentStepEl.classList.remove('active', 'slide-out');
                        prevStepEl.style.display = 'block';
                        prevStepEl.classList.add('active', 'slide-in');
                        
                        setTimeout(() => {
                            prevStepEl.classList.remove('slide-in');
                        }, 500);
                        
                        currentStep--;
                        updateProgress();
                        validateStep(currentStep);
                    }, 500);
                }
            }
        }

        function togglePreference(element) {
            element.classList.toggle('selected');
            const value = element.getAttribute('data-value');
            const step = element.closest('.setup-step').getAttribute('data-step');
            let category;
            
            switch(step) {
                case '5':
                    category = 'interests';
                    break;
                case '6':
                    category = 'preferences';
                    break;
                case '7':
                    category = 'communicationStyle';
                    break;
                case '8':
                    category = 'responsePreferences';
                    break;
                case '9':
                    category = 'learningStyle';
                    break;
                case '10':
                    category = 'developmentTools';
                    break;
                default:
                    return;
            }
            
            if (element.classList.contains('selected')) {
                if (!userPreferences[category].includes(value)) {
                    userPreferences[category].push(value);
                }
            } else {
                userPreferences[category] = userPreferences[category].filter(v => v !== value);
            }
            
            validateStep(parseInt(step));
        }

        // Add media queries for responsive grid
        const responsiveStyles = document.createElement('style');
        responsiveStyles.textContent = `
            @media (max-width: 1200px) {
                .preference-options {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
            
            @media (max-width: 768px) {
                .preference-options {
                    grid-template-columns: repeat(1, 1fr);
                }
                
                .setup-step {
                    padding: 1rem;
                }
            }
        `;
        document.head.appendChild(responsiveStyles);

        function updateSystemInstructions() {
            let customInstructions = DEFAULT_SYSTEM_INSTRUCTIONS;
            
            // Add communication style preferences
            if (userPreferences.communicationStyle.includes('detailed')) {
                customInstructions += '\nProvide detailed and comprehensive explanations.';
            }
            if (userPreferences.communicationStyle.includes('concise')) {
                customInstructions += '\nFocus on brevity and clarity in responses.';
            }
            if (userPreferences.communicationStyle.includes('technical')) {
                customInstructions += '\nUse technical terminology and in-depth explanations.';
            }
            if (userPreferences.communicationStyle.includes('casual')) {
                customInstructions += '\nMaintain a friendly and conversational tone.';
            }
            if (userPreferences.communicationStyle.includes('professional')) {
                customInstructions += '\nMaintain a professional and formal tone.';
            }
            if (userPreferences.communicationStyle.includes('educational')) {
                customInstructions += '\nFocus on teaching and explaining concepts clearly.';
            }
            
            // Add response preferences
            if (userPreferences.responsePreferences.includes('step_by_step')) {
                customInstructions += '\nBreak down complex explanations into clear steps.';
            }
            if (userPreferences.responsePreferences.includes('examples')) {
                customInstructions += '\nInclude practical examples in explanations.';
            }
            if (userPreferences.responsePreferences.includes('analogies')) {
                customInstructions += '\nUse analogies to explain complex concepts.';
            }
            if (userPreferences.responsePreferences.includes('best_practices')) {
                customInstructions += '\nHighlight industry best practices and standards.';
            }
            if (userPreferences.responsePreferences.includes('alternatives')) {
                customInstructions += '\nProvide alternative approaches when relevant.';
            }
            
            // Add learning style preferences
            if (userPreferences.learningStyle.includes('visual')) {
                customInstructions += '\nUse visual explanations when possible.';
            }
            if (userPreferences.learningStyle.includes('practical')) {
                customInstructions += '\nFocus on practical, hands-on examples.';
            }
            if (userPreferences.learningStyle.includes('theoretical')) {
                customInstructions += '\nInclude theoretical background and concepts.';
            }
            if (userPreferences.learningStyle.includes('interactive')) {
                customInstructions += '\nEncourage interactive learning and experimentation.';
            }
            
            // Add comprehensive user context
            customInstructions += `\n\nUser Context:
Name: ${userPreferences.name}
Role: ${userPreferences.role}
Experience Level: ${userPreferences.experience}
Goals: ${userPreferences.goals}
Interests: ${userPreferences.interests.join(', ')}
Use Cases: ${userPreferences.preferences.join(', ')}
Communication Style: ${userPreferences.communicationStyle.join(', ')}
Response Preferences: ${userPreferences.responsePreferences.join(', ')}
Learning Style: ${userPreferences.learningStyle.join(', ')}
Development Tools: ${userPreferences.developmentTools.join(', ')}`;
            
            SYSTEM_INSTRUCTIONS = customInstructions;
        }

        function selectTheme(theme, element) {
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            userPreferences.theme = theme;
            
            // Apply theme immediately
            isDarkTheme = theme === 'dark';  // Set isDarkTheme directly based on selection
            toggleTheme();
        }

        function updateProgress() {
            document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index < currentStep);
            });
        }
    </script>
</body>
</html>
